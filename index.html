<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="assets/vendor/bootstrap/bootstrap.min.css" type="text/css" rel="stylesheet">
    <link href="assets/vendor/select2/select2.min.css" type="text/css" rel="stylesheet">
    <link href="assets/vendor/datatables/datatables.min.css" type="text/css" rel="stylesheet">
    <link href="assets/vendor/fontawesome/css/all.css" type="text/css" rel="stylesheet">
    <link href="assets/css/custom.css" type="text/css" rel="stylesheet">
    <title>Crypto Squares</title>
    <!-- <style>
        .square {
            opacity: 0.7;
        }
        .square-text {
            font-size: 12px;
            text-anchor: middle; /* Center the text */
            fill: white; /* Text color */
        }
        .square-text-name, .square-value {
            font-size: 16px; /* Font size for name */
            font-family: 'Arial', sans-serif; /* Font style for name */
            text-anchor: middle; /* Center the text horizontally */
            fill: white; /* Text color for name */
        }
        .svg-container {
            display: inline-block;
            position: relative;
            width: 100%;
            height: 80vh; /* Adjust as needed */
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5); /* Inner shadow effect */
            border-radius: 8px; /* Optional: rounds the corners */
        }
        .bubble {
            stroke: #fff;
            stroke-width: 1.5px;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            width: 80px;
            height: 28px;
            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
    </style> -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background-color: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
            overflow-x: hidden; 
            width: 100vw;
            height: 100vh;
            /* position: fixed; */
        }

        #chart {
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        .square {
            cursor: pointer;
            transition: all 0.2s;
        }
        .crypto-logo{
            cursor: pointer;
        }

        .square-border {
            fill: none;
            stroke-width: 2;
        }

        .square-container {
            cursor: move;
            pointer-events: all;
        }

        .square-label, .percentage-label {
            cursor: pointer;
            font-weight: bold;
            text-anchor: middle;
            fill: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .currency-logo {
            pointer-events: none;
        }

        @media (max-width: 768px) {
            ul.nav.nav-pills.justify-content-center{
                font-size: 11px;
            }
            .square-label {
                font-size: 10px !important;
            }
            .percentage-label {
                font-size: 9px !important;
            }
        }
        .details-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        .details-panel.visible {
            display: block;
        }
       

.nav-tabs {
    display: flex;
    list-style: none;
    margin: 0;
    padding: 0;
    gap: 8px;
    background: linear-gradient(to right, #242f3b, #1f5839);
    padding: 8px;
    border-radius: 10px;
}

.nav-tabs li a {
    color: rgba(255, 255, 255, 0.7);
   text-decoration: none;
   padding: 8px 16px;
   border-radius: 6px;
   font-weight: 600;
   transition: all 0.2s ease;
   background: transparent;
   text-transform: uppercase;
}

.nav-tabs li a:hover {
    background: rgba(255, 255, 255, 0.2);
}

.nav-tabs li a.active {
    color: #fff;
   background: rgba(41, 128, 185, 0.8);
   box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
}

@media (max-width: 768px) {
    .nav-tabs li a {
        padding: 5px 10px;
        font-size: 10px;
    }
    
    .tabs-container {
        padding: 4px;
    }
}
.search-icon {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    color: rgba(255, 255, 255, 0.5);
    width: 30px;
    height: 20px;
    pointer-events: none;
}
.search-container {
    /* position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000; */
    width: 300px;
}

#searchInput {
    width: 300px;
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 20px;
    /*backdrop-filter: blur(5px);*/
    transition: all 0.3s ease;
    padding: 10px 15px 10px 35px; 
}

#searchInput:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.15);
    box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
}

#searchInput::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

.search-results {
    position: absolute;
    /* top: 100%;
    left: 0;
    right: 0; */
    width:300px;
    background: rgba(44, 62, 80, 0.95);
    border-radius: 8px;
    /* margin-top: 5px; */
    max-height: 500px;
    overflow-y: auto;
    display: none;
    backdrop-filter: blur(5px);
    box-sizing: border-box;
}

.search-result-item {
    padding: 10px 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    transition: background 0.2s ease;
}

.search-result-item:hover {
    background: rgba(255, 255, 255, 0.1);
}

.search-result-item img {
    width: 24px;
    height: 24px;
}
.grow {
    flex-grow: 0.5;
}
.loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #1a1a1a;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-content {
    text-align: center;
}

.loading-bar-container {
    width: 300px;
    height: 4px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    margin: 20px auto;
    overflow: hidden;
}

.loading-bar {
    width: 0%;
    height: 100%;
    background: linear-gradient(to right, #3498db, #2ecc71);
    transition: width 0.3s ease;
}

.loading-text {
    color: white;
    font-size: 18px;
    margin-bottom: 10px;
}

.loading-percentage {
    color: #3498db;
    font-size: 16px;
}
.data-updater-line {
    /* position: fixed;
    top: 0;
    left: 0; */
    width: 100%;
    height: 2px; /* Thin line */
    background: rgba(255, 255, 255, 0.1);
    z-index: 9999;
    overflow: hidden;
}

.progress-line {
    width: 100%;
    height: 100%;
    /* background: linear-gradient(90deg, 
        #00ff00 0%,
        #00ff00 35%,
        #11ff11 45%,
        #22ff22 55%,
        #33ff33 65%,
        #44ff44 75%
    ); */
    /* background: linear-gradient(90deg, 
        #22c55e 0%,    
        #16a34a 20%,   
        #22c55e 40%,  
        #4ade80 60%,   
        #22c55e 80%,   
        #16a34a 100%   
    ); */
    background: #22c55e;
    /* transform-origin: right;
    transform: scaleX(0);
    transition: transform 1s linear; */
    /* animation: gradientMove 2s linear infinite; */
    transform: translateX(-100%); /* Start from left (hidden) */
    transition: transform 180s linear; /* 60s for full animation */
}

@keyframes gradientMove {
    0% { background-position: 100% 0%; }
    100% { background-position: -100% 0%; }
}



.crypto-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(17, 24, 39, 0.95);
    border-radius: 12px;
    padding: 20px;
    min-width: 300px;
    z-index: 1000;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.popup-content {
    color: white;
}

.popup-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    position: relative;
}

.coin-logo {
    width: 40px;
    height: 40px;
    margin-right: 15px;
    border-radius: 50%;
}

.coin-info {
    flex: 1;
}

.coin-name {
    font-size: 18px;
    font-weight: 600;
}

.coin-symbol {
    font-size: 14px;
    color: rgba(255, 255, 255, 0.6);
    margin-top: 2px;
}

.close-button {
    position: absolute;
    top: -10px;
    right: -10px;
    width: 24px;
    height: 24px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 18px;
    transition: background 0.3s;
}

.close-button:hover {
    background: rgba(255, 255, 255, 0.2);
}

.popup-details {
    display: grid;
    gap: 15px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
}

.detail-label {
    color: rgba(255, 255, 255, 0.6);
    font-size: 14px;
}

.detail-value {
    font-weight: 500;
}

.change24h {
    padding: 4px 8px;
    border-radius: 4px;
}

.change24h.positive {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

.change24h.negative {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}
.overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(2px);
    z-index: 999;
}
    </style>
</head>
<body class="bg-dark">
    <header>
        <nav class="navbar navbar-expand-xl navbar-dark">
            <div class="container-fluid">
                <img height="30" style="margin: 5px;" src="/assets/images/logo2.png" alt="CS" title="Logo of CryptoSquares">
            <a class="navbar-brand" style="font-size: 35px; padding: 0px;" href="javascript:void(0)">CRYPTO SQUARES</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mynavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mynavbar">
                <div class="grow"></div>
                <div class="search-container">
                    <div class="search-input-wrapper">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Search cryptocurrency...">
                </div>
                    <div class="search-results" id="searchResults"></div>
                </div>
                <ul class="navbar-nav ms-auto">
                    
                    <!-- <li class="nav-item me-2">
                      <select class="form-select cryptocurrency" id="cryptocurrency">
                            <option selected value="search">Search Cryptocurrency</option>
                            <option value="bitcoin">Bitcoin</option>
                            <option value="ethereum">Ethereum</option>
                            <option value="tether">Tether</option>
                            <option value="bnb">BNB</option>
                            <option value="solana">Solana</option>
                            <option value="usdc">USDC</option>
                            <option value="xrp">XRP</option>
                            <option value="dogecoin">Dogecoin</option>
                            <option value="toincoin">Toincoin</option>
                            <option value="tron">TRON</option>
                        </select>
                    </li> -->
                    <li class="nav-item me-2">
                      <select class="form-select" onchange="changePage(value)">
                            <option selected value=1 >1 - 100</option>
                            <option value=2 >101 - 200</option>
                            <option value=3 >201 - 300</option>
                            <option value="4" >301 - 400</option>
                            <option value="5" >401 - 500</option>
                            <option value="6">501 - 600</option>
                            <option value="7">601 - 700</option>
                            <option value="8">701 - 800</option>
                            <option value="9">801 - 900</option>
                            <option value="10">901 - 1000</option>
                            <!-- <option disabled>List</option>
                            <option value="favorites">Favorites</option>
                            <option value="watchlist">Watchlist 1</option>
                            <option value="blocklist">Blocklist</option>
                            <option disabled>Exchanges</option>
                            <option value="binance">Binance</option>
                            <option value="mexc">MEXC</option>
                            <option value="bybit">Bybit</option>
                            <option value="kucoin">Kucoin</option>
                            <option value="gate">Gate.io</option>
                            <option value="okx">OKX</option>
                            <option value="coinbase">Coinbase</option> -->
                        </select>
                    </li>
                    <li class="nav-item me-2">
                        <select class="form-select">
                            <option disabled>Fiat</option>
                            <option selected value="usd">$ USD</option>
                            <option value="eur">€ EUR</option>
                            <option value="rub">₽ RUB</option>
                            <option value="brl">R$ BRL</option>
                            <option value="gbp">£ GBP</option>
                            <option value="inr">₹ INR</option>
                            <option value="aud">$ AUD</option>
                            <option value="cad">$ CAD</option>
                            <option value="pln">Zł PLN</option>
                            <option value="try">₺ TRY</option>
                            <option disabled>Crypto</option>
                            <option value="btc">₿ BTC</option>
                            <option value="eth">Ξ ETH</option>
                        </select>
                    </li>
                    <!-- <li class="nav-item settings">
                        <a class="nav-link text-center" data-bs-toggle="modal" data-bs-target="#myModal"><i class="fa-solid fa-gear"></i></a>
                    </li> -->
                  </ul>
            </div>
        </div>
       
        </nav>
    </header>
    <!-- Add this to your HTML -->
    <div class="data-updater-line">
        <div class="progress-line"></div>
    </div>
    <div class="loading-screen">
        <div class="loading-content">
            <div class="loading-bar-container">
                <div class="loading-bar"></div>
            </div>
            <div class="loading-text">Loading cryptocurrency data...</div>
            <div class="loading-percentage">0%</div>
        </div>
    </div>
    <div id="details" class="details-panel">
        <h3 id="details-title"></h3>
        <div id="details-content"></div>
    </div>


    <div class="overlay" id="overlay"></div>
    <div class="crypto-popup" id="cryptoPopup">
        <div class="popup-content">
            <div class="popup-header">
                <img class="coin-logo" src="" alt="coin logo">
                <div class="coin-info">
                    <div class="coin-name"></div>
                    <div class="coin-symbol"></div>
                </div>
                <div class="close-button">×</div>
            </div>
            <div class="popup-details">
                <div class="detail-row">
                    <div class="detail-label">Price</div>
                    <div class="detail-value price"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">24h Change</div>
                    <div class="detail-value change24h"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Market Cap</div>
                    <div class="detail-value market-cap"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Volume (24h)</div>
                    <div class="detail-value volume"></div>
                </div>
            </div>
        </div>
    </div>


    <section class="filter">
        <div class="tabs-container timeframe-controls">
            <ul class="nav-tabs" role="tablist">
                <li class="">
                    <a class="" data-time="1h" data-bs-toggle="pill" href="#" >Hour</a>
                </li>
                <li >
                    <a class="active" data-time="24h" data-bs-toggle="pill" href="#" >Day</a>
                </li>
                <li>
                    <a class="" data-time="7d" data-bs-toggle="pill" href="#">Week</a>
                </li>
                <li>
                    <a class="" data-time="30d" data-bs-toggle="pill" href="#">Month</a>
                </li>
                <li >
                    <a class="" data-time="365d" data-bs-toggle="pill" href="#year">Year</a>
                </li>
                <li >
                    <a class="" data-time="mcap" data-bs-toggle="pill" href="#market">Market Cap & Day</a>
                </li>
            </ul>
            
            <div class="tab-content ">
                <div id="hour" class=" tab-pane active">
                    <div class="chart-container" id="chart">
                        
                        <!-- <svg id="chart" class="chart">
                            <filter id="inner-shadow" x="-20%" y="-20%" width="200%" height="200%">
                                <feComponentTransfer in="SourceAlpha">
                                    <feFuncA type="table" tableValues="1 0"/>
                                </feComponentTransfer>
                                <feGaussianBlur stdDeviation="4" result="blur"/>
                                <feOffset dx="2" dy="2" result="offsetBlur"/>
                                <feComposite operator="in" in2="SourceAlpha" in="offsetBlur"/>
                                <feMerge>
                                    <feMergeNode/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </svg> -->
                    </div>
                </div>
                <div id="day" class="container-fluid tab-pane fade"><br>
                    <h3>Menu 1</h3>
                </div>
                <div id="week" class="container-fluid tab-pane fade"><br>
                    <h3>Menu 2</h3>
                </div>
                <div id="month" class="container-fluid tab-pane fade"><br>
                    <h3>Menu 2</h3>
                </div>
                <div id="year" class="container-fluid tab-pane fade"><br>
                    <h3>Menu 2</h3>
                </div>
                <div id="market" class="container tab-pane fade"><br>
                    <h3>Menu 2</h3>
                </div>
            </div>
        </div>
    </section>
    
    <section class="mt-3">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped table-dark">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Name</th>
                                    <th>Price</th>
                                    <th>Market Cap</th>
                                    <th>24h Volume</th>
                                    <th>Hour</th>
                                    <th>Day</th>
                                    <th>Week</th>
                                    <th>Month</th>
                                    <th>Year</th>
                                    <th colspan="4" class="text-center">Links</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td>Bitcon</td>
                                    <td>$63,813</td>
                                    <td>$1.26T</td>
                                    <td>$28.77B</td>
                                    <td>-0.14%</td>
                                    <td>+0.43%</td>
                                    <td>+6.5%</td>
                                    <td>-0.19%</td>
                                    <td>+143%</td>
                                    <td><a target="_blank" rel="noopener" href="https://coinmarketcap.com/currencies/bitcoin" title="View Bitcoin on CoinMarketCap" class="icon-button"><svg viewBox="-7 -7 55 55"><rect x="-7" y="-7" width="64" height="64" fill="#3861fb" rx="12"></rect><path d="m35.124 24.5c-0.715 0.452-1.557 0.508-2.197 0.147-0.813-0.459-1.26-1.534-1.26-3.029v-4.473c0-2.16-0.854-3.697-2.282-4.112-2.42-0.705-4.24 2.256-4.924 3.368l-4.268 6.92v-8.458c-0.048-1.946-0.68-3.11-1.88-3.461-0.794-0.232-1.982-0.139-3.136 1.627l-9.562 15.354c-1.2801-2.4302-1.9475-5.1363-1.944-7.883 0-9.249 7.412-16.773 16.522-16.773s16.521 7.524 16.521 16.773c0 0.016 4e-3 0.03 5e-3 0.045 0 0.016-3e-3 0.03-2e-3 0.046 0.086 1.791-0.494 3.216-1.593 3.91zm5.261-3.999v-0.047l-1e-3 -0.046c-0.051-11.264-9.088-20.408-20.192-20.408-11.133 0-20.192 9.196-20.192 20.5 0 11.303 9.059 20.5 20.193 20.5 5.109 0 9.985-1.942 13.728-5.467 0.744-0.7 0.788-1.879 0.098-2.633-0.68394-0.7542-1.854-0.79931-2.594-0.1-3.0339 2.873-7.0536 4.4738-11.232 4.473-4.878 0-9.267-2.159-12.294-5.583l8.623-13.846v6.383c0 3.066 1.189 4.057 2.186 4.347 0.998 0.29 2.523 0.092 4.124-2.508l4.743-7.689c0.152-0.248 0.292-0.462 0.42-0.647v3.888c0 2.866 1.148 5.158 3.149 6.287 1.804 1.018 4.072 0.926 5.92-0.24 2.24-1.415 3.447-4.022 3.321-7.164z" fill="#fff"></path></svg></a></td>
                                    <td><a target="_blank" rel="noopener" href="https://www.coingecko.com/coins/usd-coin" title="View USDC on CoinGecko" class="icon-button"><svg viewBox="0 0 96 96"><path d="M95.3201 47.7848C95.437 74.2931 74.1955 95.8818 47.8757 95.9995C21.5525 96.1172 0.120677 74.7236 0.00047986 48.2152C-0.116378 21.7035 21.1251 0.118179 47.445 0.000483373C73.7681 -0.117212 95.2 21.2731 95.3168 47.7848H95.3201Z" fill="#8DC63F"></path><path d="M91.7276 47.7979C91.8378 72.3122 72.1955 92.2733 47.859 92.3843C23.519 92.4953 3.69988 72.7124 3.58969 48.1981C3.47951 23.6839 23.1217 3.72273 47.4616 3.61177C71.7982 3.50416 91.6174 23.2837 91.7276 47.7979Z" fill="#F9E988"></path><path d="M70.0087 32.1144C66.8101 31.183 63.498 29.8581 60.1392 28.5231C59.9455 27.6756 59.201 26.6198 57.6918 25.3251C55.4982 23.4083 51.3781 23.4588 47.819 24.3062C43.8892 23.3747 40.0062 23.0418 36.2801 23.943C5.81008 32.4003 23.0851 53.0239 11.8967 73.7618C13.4893 77.1615 30.6475 97.0083 55.4749 91.6817C55.4749 91.6817 46.9843 71.1321 66.1457 61.2659C81.6879 53.266 92.9163 38.4095 70.0054 32.1111L70.0087 32.1144Z" fill="#8BC53F"></path><path d="M49.9291 37.0607C49.9291 41.8022 46.1128 45.6424 41.4085 45.6424C36.7041 45.6424 32.8878 41.8022 32.8878 37.0607C32.8878 32.3193 36.7041 28.4824 41.4085 28.4824C46.1128 28.4824 49.9291 32.3227 49.9291 37.0607Z" fill="white"></path><path d="M47.4049 37.1416C47.4049 40.474 44.7205 43.1776 41.4117 43.1776C38.103 43.1776 35.4186 40.4774 35.4186 37.1416C35.4186 33.8057 38.103 31.1055 41.4117 31.1055C44.7205 31.1055 47.4049 33.8091 47.4049 37.1416Z" fill="#58595B"></path><path d="M80.6726 49.4091C73.7713 54.3086 65.9151 58.0244 54.7802 58.0244C49.5683 58.0244 48.5099 52.4457 45.0643 55.1796C43.2847 56.5919 37.0144 59.7495 32.0362 59.5108C27.0146 59.2687 18.9982 56.3296 16.7445 45.6328C15.853 56.3296 15.3989 64.2119 11.4091 73.2441C19.3521 86.0527 38.2865 95.9324 55.4747 91.6853C53.6283 78.6951 64.9001 65.9739 71.2505 59.4637C73.6545 56.9988 78.262 52.9736 80.6726 49.4091Z" fill="#8BC53F"></path><path d="M80.4024 49.7321C78.2588 51.6993 75.708 53.1587 73.1104 54.4432C70.4861 55.6908 67.7516 56.7063 64.927 57.4428C62.1124 58.1759 59.1709 58.7273 56.1927 58.4583C53.2679 58.1994 50.1761 57.1637 48.2029 54.9207L48.2964 54.8131C50.7304 56.3936 53.5049 56.9485 56.2795 57.0292C59.054 57.1032 61.882 56.8947 64.6699 56.3264C67.4511 55.748 70.1823 54.8838 72.8233 53.7875C75.4576 52.6913 78.0619 51.4235 80.3089 49.6211L80.399 49.7287L80.4024 49.7321Z" fill="#58595B"></path></svg></a></td>
                                    <td><a target="_blank" rel="noopener" href="https://www.tradingview.com/chart/?symbol=BINANCE:USDCUSDT" title="View USDC on TradingView" class="icon-button"><svg viewBox="0 0 180 180"><rect width="180" height="180" fill="black"></rect><path d="M115.055 72.5C115.055 79.8638 109.086 85.8333 101.722 85.8333C94.3583 85.8333 88.3888 79.8638 88.3888 72.5C88.3888 65.1362 94.3583 59.1667 101.722 59.1667C109.086 59.1667 115.055 65.1362 115.055 72.5ZM81.9999 59.7778H28.6667L28.6665 86.4444H55.3332V125.556H81.9999V59.7778ZM128.755 59.7778H159.333L131.778 125.556H101.111L128.755 59.7778Z" fill="white"></path></svg></a></td>
                                    <td>
                                        <button class="solid-button" title="Trade Bitcoin on Binance, MEXC, Bybit, Kucoin, Gate.io, Bitget, BitMart, BingX, OKX, Coinbase">
                                        	<svg viewBox="0 0 2500 2500" style="margin-right: -6px;">
                                        		<path fill="#fdd430" d="M764.48,1050.52,1250,565l485.75,485.73,282.5-282.5L1250,0,482,768l282.49,282.5M0,1250,282.51,967.45,565,1249.94,282.49,1532.45Zm764.48,199.51L1250,1935l485.74-485.72,282.65,282.35-.14.15L1250,2500,482,1732l-.4-.4,282.91-282.12M1935,1250.12l282.51-282.51L2500,1250.1,2217.5,1532.61Z"></path>
                                        		<path fill="#fdd430" d="M1536.52,1249.85h.12L1250,963.19,1038.13,1175h0l-24.34,24.35-50.2,50.21-.4.39.4.41L1250,1536.81l286.66-286.66.14-.16-.26-.14"></path>
                                        	</svg>
                                        	<svg viewBox="0 0 2500 2500" style="margin-right: -6px;">
                                        		<path d="M2459.7,1566.6l-540.6-937.7c-118.5-195.5-407.5-197.5-521.9,8.3l-567.6,975.2 c-106,178.8,25,403.3,237.1,403.3H2204C2418.1,2015.7,2578.2,1784.9,2459.7,1566.6z" fill="#003087"></path>
                                        		<path d="M1680,1639.4l-33.3-58.2c-31.2-54.1-99.8-170.5-99.8-170.5l-457.4-794.3C971,439.7,690.3,425.1,571.8,647.6 L39.5,1568.7c-110.2,193.4,20.8,444.9,259.9,447h1131.1h482.4h286.9C1906.7,2017.8,1813.1,1866,1680,1639.4L1680,1639.4z" fill="#1972E2"></path>
                                        		<linearGradient id="mexc-gradient" gradientUnits="userSpaceOnUse" x1="703.637" y1="1211.6566" x2="1935.647" y2="727.2267" gradientTransform="matrix(1 0 0 -1 0 2500)">
                                        			<stop offset="0" style="stop-color: rgb(38, 76, 162); stop-opacity: 0;"></stop>
                                        			<stop offset="1" style="stop-color: rgb(35, 69, 136);"></stop>
                                        		</linearGradient>
                                        		<path d="M1680.1,1639.4l-33.3-58.2c-31.2-54.1-99.8-170.5-99.8-170.5l-295.3-519.8l-424.2,723.6 c-106,178.8,25,403.4,237,403.4h363.9h482.4h289C1904.6,2015.7,1813.1,1866,1680.1,1639.4L1680.1,1639.4z" fill="url(#mexc-gradient)"></path>
                                        	</svg>
                                        	<svg viewBox="8 8 84 84" style="margin-right: -6px;">
                                        		<path fill="#F7A600" d="m69.17248,54.28325l0,-22.3572l4.4939,0l0,22.3572l-4.4939,0z"></path>
                                        		<path fill="white" d="m16.79825,60.92435l-9.63407,0l0,-22.35719l9.24666,0c4.49394,0 7.11244,2.44919 7.11244,6.28029c0,2.4799 -1.6817,4.0825 -2.8457,4.6161c1.3894,0.6277 3.1679,2.0404 3.1679,5.0249c0,4.1749 -2.9407,6.4359 -7.04723,6.4359zm-0.74311,-18.4628l-4.39706,0l0,5.1497l4.39706,0c1.90714,0 2.97424,-1.0364 2.97424,-2.5757c0,-1.5376 -1.0671,-2.574 -2.97424,-2.574zm0.29055,9.0749l-4.68761,0l0,5.4952l4.68761,0c2.03739,0 3.00589,-1.2553 3.00589,-2.7638c0,-1.5068 -0.9703,-2.7314 -3.00589,-2.7314z"></path>
                                        		<path fill="white" d="m37.55238,51.75535l0,9.169l-4.4622,0l0,-9.169l-6.9187,-13.18819l4.8813,0l4.3002,9.01159l4.2351,-9.01159l4.8813,0l-6.917,13.18819z"></path>
                                        		<path fill="white" d="m57.20988,60.92435l-9.6341,0l0,-22.35719l9.2467,0c4.4939,0 7.1124,2.44919 7.1124,6.28029c0,2.4799 -1.6817,4.0825 -2.8457,4.6161c1.3894,0.6277 3.168,2.0404 3.168,5.0249c0,4.1749 -2.9408,6.4359 -7.0473,6.4359zm-0.7431,-18.4628l-4.3971,0l0,5.1497l4.3971,0c1.9071,0 2.9742,-1.0364 2.9742,-2.5757c0,-1.5376 -1.0671,-2.574 -2.9742,-2.574zm0.2905,9.0749l-4.6876,0l0,5.4952l4.6876,0c2.0374,0 3.0059,-1.2553 3.0059,-2.7638c0,-1.5068 -0.9685,-2.7314 -3.0059,-2.7314z"></path>
                                        		<path fill="white" d="m88.15018,42.46155l0,18.4645l-4.4939,0l0,-18.4645l-6.0136,0l0,-3.89439l16.5211,0l0,3.89439l-6.0136,0z"></path>
                                        	</svg>
                                        	<svg viewBox="0 0 24 24" style="margin-right: -6px;">
                                        		<path fill="#24ae8f" d="m7.9 12 7.1 6.5 4.5-4.1a2 1.9 0 1 1 2.9 2.6l-5.9 5.4a2.1 1.9 0 0 1-2.9 0l-8.5-7.8v4.7a2 1.9 0 1 1-4.1 0v-15a2 1.9 0 1 1 4.1 0v4.7l8.5-7.8a2.1 1.9 0 0 1 2.9 0l5.9 5.4a2 1.9 0 1 1-2.9 2.6l-4.5-4.1zm7.1-1.9a2 1.9 0 1 0 2 1.9 2 1.9 0 0 0-2-1.9z"></path>
                                        	</svg>
                                        	<svg viewBox="0 0 229 229" style="margin-right: -6px;">
                                        		<path fill="#2354e6" d="M114.475154,177.475321 C79.7034538,177.475321 51.5151256,149.282841 51.5151256,114.500713 C51.5151256,79.7209602 79.7034538,51.5237291 114.475154,51.5237291 L114.475154,-0.000950201555 C51.2515057,-0.000950201555 -1.68750626e-14,51.2624237 -1.68750626e-14,114.500713 C-1.68750626e-14,177.736626 51.2515057,229 114.475154,229 C177.696428,229 228.950308,177.736626 228.950308,114.500713 L177.435183,114.500713 C177.435183,149.282841 149.246855,177.475321 114.475154,177.475321"></path>
                                        		<polygon fill="#17E6A1" points="114.474679 114.499287 177.434708 114.499287 177.434708 51.5246793 114.474679 51.5246793"></polygon>
                                        	</svg>
                                        	<svg viewBox="0 0 40 40" style="margin-right: -6px;">
                                        		<rect x="0" width="40" height="40" rx="8.7109404" fill="#00f0ff" y="0"></rect>
                                        		<path d="m 18.459617,15.7671 h 7.4686 l 7.6404,7.5916 c 0.497,0.4938 0.4996,1.2971 0.0051,1.7934 L 23.775317,35 h -7.6937 l 2.326,-2.2613 8.54,-8.4861 -8.4316,-8.4862" fill="#1b1b1b"></path>
                                        		<path d="m 21.529217,24.2336 h -7.4686 l -7.64042,-7.5917 c -0.49702,-0.4938 -0.49956,-1.297 -0.00508,-1.7934 L 16.213517,5 h 7.6937 l -2.326,2.26132 -8.54,8.48608 8.4316,8.4862" fill="#1b1b1b"></path>
                                        	</svg>
                                        	<svg viewBox="-20 0 267 267" style="margin-right: -6px;">
                                        		<path d="M144.047 191.872H62.2373V199.02H144.047V191.872Z" fill="#000"></path>
                                        		<path d="M82.7124 236.335H21.3479V243.484H82.7124V236.335Z" fill="#000"></path>
                                        		<path d="M41.732 191.903H0.903076V199.051H41.732V191.903Z" fill="#000"></path>
                                        		<path d="M144.047 171.215H82.6821V178.363H144.047V171.215Z" fill="#000"></path>
                                        		<path d="M62.1768 171.215H21.3782V178.363H62.1768V171.215Z" fill="#000"></path>
                                        		<path d="M144.046 78.8052H41.7622V85.9533H144.046V78.8052Z" fill="#000"></path>
                                        		<path d="M62.1768 55.0293H21.3479V62.1774H62.1768V55.0293Z" fill="#000"></path>
                                        		<path d="M198.293 123.753V123.572C205.417 111.129 209.151 97.0353 209.122 82.6979C209.093 68.3604 205.302 54.2817 198.128 41.8681C190.954 29.4546 180.648 19.141 168.24 11.9578C155.832 4.77458 141.756 0.973239 127.418 0.933594H41.7623V11.1711H127.661C138.664 11.2147 149.509 13.7924 159.354 18.7043C169.2 23.6162 177.782 30.7303 184.435 39.4946C191.087 48.259 195.631 58.438 197.714 69.2421C199.797 80.0462 199.363 91.185 196.446 101.794C198.583 92.6172 198.622 83.0763 196.56 73.8821C194.498 64.6879 190.388 56.0774 184.537 48.6918C178.685 41.3062 171.243 35.336 162.764 31.2257C154.285 27.1155 144.988 24.9711 135.566 24.9524H62.2374V35.1899H135.657C143.884 35.1927 151.995 37.1361 159.33 40.8623C166.665 44.5885 173.018 49.9923 177.872 56.6349C182.726 63.2775 185.945 70.9715 187.267 79.0918C188.589 87.2122 187.978 95.5299 185.481 103.369C187.086 97.3209 187.285 90.9853 186.062 84.8483C184.838 78.7113 182.226 72.9359 178.425 67.965C174.624 62.9941 169.734 58.9598 164.132 56.1714C158.53 53.383 152.364 51.9146 146.106 51.8788H82.5004V62.2072H145.803C151.18 62.2172 156.459 63.6355 161.117 66.3209C165.775 69.0063 169.647 72.865 172.35 77.5128C175.052 82.1606 176.489 87.4352 176.519 92.8114C176.548 98.1876 175.169 103.478 172.518 108.155C163.369 104.753 153.687 103.009 143.925 103.006H62.1465V113.243H143.925C160.607 113.246 176.765 119.068 189.614 129.706C202.464 140.343 211.2 155.131 214.316 171.518C211.207 157.983 203.603 145.901 192.745 137.243C181.886 128.585 168.414 123.862 154.526 123.844H41.7321V133.991H154.678C166.943 134.032 178.785 138.482 188.043 146.527C197.3 154.573 203.357 165.679 205.108 177.818C203.381 168.414 198.416 159.912 191.074 153.787C183.732 147.662 174.477 144.302 164.915 144.289H41.7926V154.527H164.885C173.023 154.527 180.827 157.759 186.581 163.513C192.335 169.267 195.567 177.071 195.567 185.209C195.567 193.346 192.335 201.15 186.581 206.904C180.827 212.658 173.023 215.891 164.885 215.891H21.3479V226.129H164.915C174.477 226.116 183.732 222.756 191.074 216.631C198.416 210.506 203.381 202.003 205.108 192.599C203.333 204.748 197.246 215.853 187.959 223.883C178.671 231.914 166.804 236.334 154.526 236.336H103.036V246.573H154.526C167.864 246.555 180.833 242.199 191.477 234.161C202.12 226.124 209.861 214.842 213.528 202.019C209.696 217.553 200.777 231.359 188.191 241.239C175.606 251.118 160.077 256.504 144.077 256.538H41.8835V266.776H143.925C160.566 266.856 176.835 261.858 190.561 252.448C204.286 243.039 214.814 229.666 220.739 214.116C226.664 198.566 227.705 181.578 223.721 165.421C219.737 149.264 210.919 134.707 198.445 123.693L198.293 123.753Z" fill="#000"></path>
                                        	</svg>
                                        	<svg viewBox="0 0 150 150" style="margin-right: -6px;">
                                        		<defs>
                                        			<linearGradient id="d" x1="17.68" y1="116.45" x2="132.14" y2="32.11" gradientUnits="userSpaceOnUse">
                                        				<stop offset="0" stop-color="#2a54ff"></stop>
                                        				<stop offset=".52" stop-color="#2143cb"></stop>
                                        				<stop offset="1" stop-color="#2a54ff"></stop>
                                        			</linearGradient>
                                        		</defs>
                                        		<path fill="url(#d)" d="M140.2,22.33c-25.18-.09-49.79,10.83-66.63,29.47-6.06,6.27-10.1,13.95-14.96,21.06-11.64,15.93-29.81,25.14-49.5,25.13h0v28.65h0c25.17,.1,49.78-10.86,66.63-29.5,6.03-6.27,10.13-13.94,14.96-21.06,11.64-15.91,29.81-25.12,49.5-25.11V22.33h0Z"></path>
                                        		<path fill="#2a54ff" d="M140.2,97.99c-19.68,0-37.86-9.2-49.5-25.11-4.81-7.12-8.92-14.78-14.94-21.06C58.95,33.18,34.3,22.24,9.13,22.35h0v28.65h0c21.8-.11,42.05,11.62,53.01,30.46,3.22,5.62,7.06,10.9,11.45,15.74,16.83,18.63,41.46,29.59,66.63,29.5l-.02-28.7h0Z"></path>
                                        	</svg>
                                        	<svg viewBox="0 0 24 24" style="margin-right: -6px;">
                                        		<rect x="1" y="1" width="22" height="22" fill="#000"></rect>
                                        		<rect x="6" y="6" width="4" height="4" fill="#fff"></rect>
                                        		<rect x="14" y="6" width="4" height="4" fill="#fff"></rect>
                                        		<rect x="10" y="10" width="4" height="4" fill="#fff"></rect>
                                        		<rect x="6" y="14" width="4" height="4" fill="#fff"></rect>
                                        		<rect x="14" y="14" width="4" height="4" fill="#fff"></rect>
                                        	</svg>
                                        	<svg viewBox="62 62 900 900" style="margin-right: -6px;">
                                        		<path d="M512.147 692C412.697 692 332.146 611.45 332.146 512C332.146 412.55 412.697 332 512.147 332C601.247 332 675.197 396.95 689.447 482H870.797C855.497 297.2 700.846 152 512.147 152C313.396 152 152.146 313.25 152.146 512C152.146 710.75 313.396 872 512.147 872C700.846 872 855.497 726.8 870.797 542H689.297C675.047 627.05 601.247 692 512.147 692Z" fill="#fff"></path>
                                        	</svg>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>
        
    <div class="modal" id="myModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title"><i class="fa-solid fa-gear me-3"></i>Settings</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <div class="col-12 col-lg-6 my-auto">
                            <label for="currency">Currency:</label>
                        </div>
                        <div class="col-12 col-lg-6">
                            <select class="form-select" id="currency">
                                <option disabled>Fiat</option>
                                <option selected value="usd">$ USD</option>
                                <option value="eur">€ EUR</option>
                                <option value="rub">₽ RUB</option>
                                <option value="brl">R$ BRL</option>
                                <option value="gbp">£ GBP</option>
                                <option value="inr">₹ INR</option>
                                <option value="aud">$ AUD</option>
                                <option value="cad">$ CAD</option>
                                <option value="pln">Zł PLN</option>
                                <option value="try">₺ TRY</option>
                                <option disabled>Crypto</option>
                                <option value="btc">₿ BTC</option>
                                <option value="eth">Ξ ETH</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12 col-lg-6 my-auto">
                            <label for="language">Language:</label>
                        </div>
                        <div class="col-12 col-lg-6">
                            <select class="form-select" id="language">
                                <option selected value="usd">English</option>
                                <option value="eur">Русский</option>
                                <option value="rub">Portugues</option>
                                <option value="brl">Français</option>
                                <option value="gbp">Deutsch</option>
                                <option value="inr">فارسی</option>
                                <option value="aud">Polski</option>
                                <option value="cad">Español</option>
                                <option value="pln">Nederlands</option>
                                <option value="try">Italian</option>
                                <option value="">Türkçe</option>
                                <option value="btc">العربية</option>
                                <option value="eth">ไทย</option>
                                <option>日本語</option>
                                <option>简体中文</option>
                                <option>Українська</option>
                                <option>Čeština</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12 col-lg-6 my-auto">
                            <label for="colors">Colors:</label>
                        </div>
                        <div class="col-12 col-lg-6">
                            <select class="form-select" id="colors">
                                <option selected value="red-green">Red + Geen</option>
                                <option value="yellow-blue">Yellow + Blue</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12 col-lg-6 my-auto">
                            <label for="stablecoins">Stablecoins:</label>
                        </div>
                        <div class="col-12 col-lg-6">
                            <select class="form-select" id="tablecoins">
                                <option selected value="show">Show</option>
                                <option value="hide">Hide</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- <section class="window bubble-window" id="modal2"> -->
        <!-- <header class="flex-row gap-m">
            <button class="icon-button expand-button expanded" title="Toggle expansion">
                <svg viewBox="0 0 24 24">
                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path>
                </svg>
            </button>
            <button class="icon-button button-lists" title="Add to List">
                <svg viewBox="0 0 24 24">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path>
                </svg>
            </button>
            <div class="flex-row gap-m grow">
                <img height="24" src="/1027.png" alt="Hedera" title="Logo of Hedera"><span>Hedera</span>
            </div>
            <button class="icon-button modal-close" title="Close window">
                <svg viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z">

                    </path>
                </svg>
            </button>
        </header> -->
    <!-- </section> -->


    <div class="modal colorw" id="modal2">
        <div class="modal-dialog modal-lg">
            <div class="modal-content modalc">
                <div class="modal-header">
                    <img src="/1831.png">
                    <h4 class="modal-title" style="color: white;margin-left:20px;">BitCoin</h4>
                    <button type="button" class="modal-close btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body colorw">
                    <div class="row">
                        <div class="col-12 col-lg-6 my-auto">
                            <label for="currency">Currency:</label>
                        </div>
                        <div class="col-12 col-lg-6 colorw">
                            <select class="form-select colorw" id="currency">
                                <option disabled>Fiat</option>
                                <option selected value="usd">$ USD</option>
                                <option value="eur">€ EUR</option>
                                <option value="rub">₽ RUB</option>
                                <option value="brl">R$ BRL</option>
                                <option value="gbp">£ GBP</option>
                                <option value="inr">₹ INR</option>
                                <option value="aud">$ AUD</option>
                                <option value="cad">$ CAD</option>
                                <option value="pln">Zł PLN</option>
                                <option value="try">₺ TRY</option>
                                <option disabled>Crypto</option>
                                <option value="btc">₿ BTC</option>
                                <option value="eth">Ξ ETH</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12 col-lg-6 my-auto">
                            <label for="language">Language:</label>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12 col-lg-6 my-auto">
                            <label for="colors">Colors:</label>
                        </div>
                        <div class="col-12 col-lg-6">
                            <select class="form-select" id="colors">
                                <option selected value="red-green">Red + Geen</option>
                                <option value="yellow-blue">Yellow + Blue</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12 col-lg-6 my-auto">
                            <label for="stablecoins">Stablecoins:</label>
                        </div>
                        <div class="col-12 col-lg-6">
                            <select class="form-select" id="tablecoins">
                                <option selected value="show">Show</option>
                                <option value="hide">Hide</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="assets/vendor/d3/d3.v7.min.js"></script>
    <script src="assets/vendor/jquery/jquery.js"></script>
    <script src="assets/vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/select2/select2.min.js"></script>
    <script src="assets/vendor/datatables/datatables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    
    <script>
        let session_timeframe ='24h';
        function getResponsiveSizes() {
                let width = window.innerWidth;
                let height = window.innerHeight * 0.87;
                const isSmallScreen = width < 768;
                if (isSmallScreen)
                    width = window.innerWidth * 0.98;
                height = window.innerHeight * 0.82;
                // Different sizes for first page vs other pages
                return {
                    width,
                    height, isSmallScreen,
                    minSize: isSmallScreen ? 30 : 60, // Bigger minimum for first page
                    maxSize: isSmallScreen ? 60 : 120, // Bigger maximum for first page
                    padding: isSmallScreen ? 3 : 5,
                    logoScale: isSmallScreen ? 0.2 : 0.3,
                    textScale: isSmallScreen ? 0.12 : 0.18,
                    collisionStrength: isSmallScreen ? 0.7 : 0.9,
                    chargeStrength: isSmallScreen ? -30 : -50
                };
            }
        function calculateSquareSize(change24h, screenWidth, change) {
                const absChange = Math.abs(change24h);

                const maxSize = Math.min(screenWidth, window.innerHeight) * 0.40; // 15% of smaller screen dimension
                let minSize = maxSize * 0.1; 
                let size;
                // For small screens (mobile)
                if (screenWidth < 768) {
                    //if (absChange > 200) return 100;        // >200%
                    //if (absChange > 150) return 90;         // 150-200%
                    if (absChange > 100) return 100 ;         // 100-150%
                    //if (absChange > 50) return 70;          // 50-100%
                    //if (absChange > 30) return 60;          // 30-50%
                    if (absChange > 20) return 70;          // 20-30%
                    if (absChange > 10) return 60;          // 10-20%
                    if (absChange > 5) return 50;           // 5-10%
                    if (absChange > 3) return 45;           // 3-5%
                    if (absChange > 2) return 40;           // 1-3%
                    if (absChange > 1) return 30;           // 1-3%
                    return 20;                              // 0-1%
                    
                }
                // For medium screens (tablet)
                else if (screenWidth < 1024) {
                    if (absChange > 100) return 130;
                    if (absChange > 20) return 90;
                    if (absChange > 10) return 70;
                    if (absChange > 5) return 60;
                    if (absChange > 3) return 50;
                    if (absChange > 1) return 30;
                    return 20;
                }
                // For large screens (desktop)
                else {
                    if(change == '1h')
                    {
                        
                        if (absChange > 100){size = 0.9 * maxSize; return Math.max(size, minSize);}
                        if (absChange > 30){ size = (0.75 * maxSize); return Math.max(size, minSize);}
                        if (absChange > 20){ size = (0.7 * maxSize); return Math.max(size, minSize);}
                        if (absChange > 10){ size = (0.6 * maxSize); return Math.max(size, minSize);}
                        if (absChange > 5){ size = (0.5 * maxSize); return Math.max(size, minSize);}
                        //if (absChange > 4){ size = (0.6 * maxSize); return Math.max(size, minSize);}
                        //if (absChange > 3){ size = (0.4 * maxSize); return Math.max(size, minSize);}
                        if (absChange > 2){ size = (0.35 * maxSize); return Math.max(size, minSize);}
                        if (absChange > 1){ size = (0.3 * maxSize); return Math.max(size, minSize);}
                        if (absChange > 0.5){ size = (0.25 * maxSize); return Math.max(size, minSize);}
                        if (absChange < 0.5){ size = minSize;}
                        return Math.max(size, minSize);
                    }
                    if(change == '24h')
                    {
                        //if (absChange > 200) return 250;
                        //if (absChange > 150) return 220;
                        if (absChange > 100) return 160;
                        //if (absChange > 50) return 160;
                        //if (absChange > 30) return 150;
                        if (absChange > 20) return 120;
                        if (absChange > 10) return 100;
                        if (absChange > 5) return 80;
                        if (absChange > 3) return 60;
                        if (absChange > 1) return 40;
                        return 20;
                    }
                    if(change == '7d')
                    {
                        if (absChange > 1000) return 180;
                        if (absChange > 900) return 170;
                        if (absChange > 700) return 160;
                        if (absChange > 500) return 150;
                        if (absChange > 400) return 140;
                        if (absChange > 300) return 130;
                        if (absChange > 200) return 120;
                        if (absChange > 100) return 110;
                        if (absChange > 30) return 90;
                        if (absChange > 20) return 80;
                        if (absChange > 10) return 70;
                        if (absChange > 5) return 50;
                        return 30;
                    }
                    if(change == '30d')
                    {
                        if (absChange > 1000) return 180;
                        if (absChange > 900) return 170;
                        if (absChange > 700) return 160;
                        if (absChange > 500) return 150;
                        if (absChange > 400) return 140;
                        if (absChange > 300) return 120;
                        if (absChange > 200) return 110;
                        if (absChange > 100) return 100;
                        if (absChange > 30) return 70;
                        if (absChange > 20) return 60;
                        if (absChange > 10) return 50;
                        if (absChange > 5) return 40;
                        return 20;
                    }
                }
            }

        // const data = Array.from({ length: 80 }, (_, i) => ({
        //     symbol: `COIN${(i + 1).toString().padStart(2, '0')}`,
        //     name: `Coin ${i + 1}`,
        //     price: Math.random() * 10000,
        //     change24h: Number((Math.random() * 20 - 10).toFixed(2)),
        //     marketCap: Math.random() * 1000000000000,
        //     logoColor: `hsl(${Math.random() * 360}, 70%, 50%)`
        // }));
//         const data = [
//     {
//         id: "bitcoin",
//         symbol: "BTC",
//         name: "Bitcoin",
//         price: 65432.10,
//         change24h: 2.45,
//         marketCap: 1278456789012,
//         volume: 32456789012,
//         logoUrl: "https://assets.coingecko.com/coins/images/1/large/bitcoin.png",
//         high24h: 66000.00,
//         low24h: 64000.00,
//         circulatingSupply: 19543212,
//         totalSupply: 21000000,
//         ath: 69000,
//         athChangePercentage: -5.2
//     },
//     {
//         id: "ethereum",
//         symbol: "ETH",
//         name: "Ethereum",
//         price: 3245.67,
//         change24h: -1.23,
//         marketCap: 389456789012,
//         volume: 15678901234,
//         logoUrl: "https://assets.coingecko.com/coins/images/279/large/ethereum.png",
//         high24h: 3300.00,
//         low24h: 3200.00,
//         circulatingSupply: 120123456,
//         totalSupply: null,
//         ath: 4878.26,
//         athChangePercentage: -33.45
//     },
//     {
//         id: "binancecoin",
//         symbol: "BNB",
//         name: "BNB",
//         price: 456.78,
//         change24h: 3.21,
//         marketCap: 75678901234,
//         volume: 2345678901,
//         logoUrl: "https://assets.coingecko.com/coins/images/825/large/bnb-icon2_2x.png",
//         high24h: 460.00,
//         low24h: 445.00,
//         circulatingSupply: 165123456,
//         totalSupply: 165123456,
//         ath: 686.31,
//         athChangePercentage: -33.45
//     },
//     {
//         id: "solana",
//         symbol: "SOL",
//         name: "Solana",
//         price: 123.45,
//         change24h: 5.67,
//         marketCap: 45678901234,
//         volume: 3456789012,
//         logoUrl: "https://assets.coingecko.com/coins/images/4128/large/solana.png",
//         high24h: 125.00,
//         low24h: 118.00,
//         circulatingSupply: 456789012,
//         totalSupply: 534567890,
//         ath: 259.96,
//         athChangePercentage: -52.45
//     },
//     {
//         id: "cardano",
//         symbol: "ADA",
//         name: "Cardano",
//         price: 0.89,
//         change24h: -2.34,
//         marketCap: 34567890123,
//         volume: 1234567890,
//         logoUrl: "https://assets.coingecko.com/coins/images/975/large/cardano.png",
//         high24h: 0.92,
//         low24h: 0.87,
//         circulatingSupply: 35678901234,
//         totalSupply: 45000000000,
//         ath: 3.09,
//         athChangePercentage: -71.23
//     },
//     {
//         id: "ripple",
//         symbol: "XRP",
//         name: "XRP",
//         price: 1.23,
//         change24h: 4.56,
//         marketCap: 23456789012,
//         volume: 2345678901,
//         logoUrl: "https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png",
//         high24h: 1.25,
//         low24h: 1.18,
//         circulatingSupply: 45678901234,
//         totalSupply: 100000000000,
//         ath: 3.40,
//         athChangePercentage: -63.82
//     },
//     {
//         id: "polkadot",
//         symbol: "DOT",
//         name: "Polkadot",
//         price: 34.56,
//         change24h: -1.23,
//         marketCap: 12345678901,
//         volume: 987654321,
//         logoUrl: "https://assets.coingecko.com/coins/images/12171/large/polkadot.png",
//         high24h: 35.00,
//         low24h: 33.50,
//         circulatingSupply: 1234567890,
//         totalSupply: 1234567890,
//         ath: 54.98,
//         athChangePercentage: -37.14
//     },
//     {
//         id: "dogecoin",
//         symbol: "DOGE",
//         name: "Dogecoin",
//         price: 0.123,
//         change24h: 7.89,
//         marketCap: 9876543210,
//         volume: 1234567890,
//         logoUrl: "https://assets.coingecko.com/coins/images/5/large/dogecoin.png",
//         high24h: 0.125,
//         low24h: 0.115,
//         circulatingSupply: 132678901234,
//         totalSupply: null,
//         ath: 0.731578,
//         athChangePercentage: -83.21
//     },
//     {
//         id: "avalanche",
//         symbol: "AVAX",
//         name: "Avalanche",
//         price: 89.12,
//         change24h: -3.45,
//         marketCap: 8765432109,
//         volume: 876543210,
//         logoUrl: "https://assets.coingecko.com/coins/images/12559/large/Avalanche_Circle_RedWhite_Trans.png",
//         high24h: 92.00,
//         low24h: 87.00,
//         circulatingSupply: 342789012,
//         totalSupply: 720000000,
//         ath: 144.96,
//         athChangePercentage: -38.52
//     },
//     {
//         id: "chainlink",
//         symbol: "LINK",
//         name: "Chainlink",
//         price: 15.67,
//         change24h: 2.34,
//         marketCap: 7654321098,
//         volume: 765432109,
//         logoUrl: "https://assets.coingecko.com/coins/images/877/large/chainlink-new-logo.png",
//         high24h: 16.00,
//         low24h: 15.20,
//         circulatingSupply: 545678901,
//         totalSupply: 1000000000,
//         ath: 52.70,
//         athChangePercentage: -70.27
//     }
// ]; 
    
    //const API_URL = 'http://localhost:3000/api/crypto';
    const API_URL = 'http://irc-library.org:8030/api/crypto';
    const CMC_CONFIG = {
        API_KEY: 'f70899e8-f0df-49d0-8fab-a038220b9f79', // Replace with your API key
        BASE_URL: 'https://pro-api.coinmarketcap.com/v1',
        PROXY_URL: API_URL
    };
        let data;
        async function fetchCryptoData(page = 1, limit = 100,timeframe = '1h', sortBy = 'percent') {

                // const PROXY_URL = 'https://api.coingecko.com/api/v3/coins/markets';

                // const API_KEY = 'f70899e8-f0df-49d0-8fab-a038220b9f79'; // Replace with your API key
                // const CMC_API_URL = 'https://pro-api.coinmarketcap.com/v1/cryptocurrency/listings/latest';

                // const params = new URLSearchParams({
                //         vs_currency: 'usd',
                //         order: 'market_cap_desc',
                //         per_page: '100',
                //         page: '1',
                //         sparkline: 'false'
                //     });
                try {
                    // Example using a proxy server - replace with your proxy URL
                    let start_ = (page - 1) * limit + 1;
                    if(isNaN(start_))
                    {
                        start_ =1;
                    }
                    const response = await fetch(`${API_URL}?start=${start_}&limit=100&timeframe=${timeframe}`);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    return data.data.map(coin => ({
                        id: coin.id,
                        symbol: coin.symbol,
                        name: coin.name,
                        price: coin.quote.USD.price,
                        change24h: coin.quote.USD.percent_change_24h,
                        change1h: coin.quote.USD.percent_change_1h,
                        change7d: coin.quote.USD.percent_change_7d,
                        change30d: coin.quote.USD.percent_change_30d,
                        change365d: coin.quote.USD.percent_change_90d,
                        marketCap: coin.quote.USD.market_cap,
                        volume: coin.quote.USD.volume_24h,
                        logoUrl: `https://s2.coinmarketcap.com/static/img/coins/64x64/${coin.id}.png`,
                        rank: coin.cmc_rank,
                        circulatingSupply: coin.circulating_supply,
                        totalSupply: coin.total_supply,
                        maxSupply: coin.max_supply,
                        volumeChange24h: coin.quote.USD.volume_change_24h,
                        marketCapChange24h: coin.quote.USD.market_cap_change_24h
                    }));


                } catch (error) {
                    console.error('Error fetching data:', error);
                    return [];
                }
            }
        

    // Initialize visualization with real data
    async function initializeWithRealData(page = 1, timeframe='24h') {


            const loading = new LoadingManager();
            loading.show();

        // Start loading sequence
        loading.setProgress(0, 'Initializing...');
        await delay(500);

        loading.setProgress(40, 'Fetching cryptocurrency data...');

                const realData = await fetchCryptoData(page,100,timeframe);

                if (realData.length === 0) {
                    alert("Error loading cryptocurrency data. Please try again later.");
                    return;
                }

                loading.setProgress(60, 'Processing data...');
                data = realData;

                // Update the data and reinitialize visualization
                loading.setProgress(80, 'Preparing visualization...');
                initializeVisualization(page,timeframe);
                // Initialize search after data is loaded
                initializeSearch();
                loading.setProgress(100, 'Completed');

        // Hide loading screen
        loading.hide();

        // Start interval after loading is complete
        //startAutoRefresh();
    }

        let sizes = getResponsiveSizes();
        let simulation;
        let svg;
        let squareGroups;
        let stroke;
        
        function getChangeForTimeframe(coin, timeframe) {
            switch(timeframe) {
                case '1h':
                    return coin.quote.USD.percent_change_1h;
                case '7d':
                    return coin.quote.USD.percent_change_7d;
                case '30d':
                    return coin.quote.USD.percent_change_30d;
                case '365d':
                    return coin.quote.USD.percent_change_90d;
                    case 'mcap' :
                        return coin.quote.USD.marketCapChange24h;
                default:
                    return coin.quote.USD.percent_change_24h;
            }
        }

         
        function initializeVisualization(page, timeframe) {

            session_timeframe = timeframe;
            var change ;
                sizes = getResponsiveSizes();
                // Sort data by rank for consistency
                // data.sort((a, b) => a.rank - b.rank);

                d3.select("#chart").selectAll("*").remove();

                svg = d3.select("#chart")
                    .append("svg")
                    .attr("width", sizes.width)
                    .attr("height", sizes.height);

                // Define filters
                const defs = svg.append("defs");

                // Create glow filter for green (positive change)
                const greenGlow = defs.append("filter")
                    .attr("id", "greenGlow")
                    .attr("x", "-50%")
                    .attr("y", "-50%")
                    .attr("width", "200%")
                    .attr("height", "200%");

                greenGlow.append("feGaussianBlur")
                    .attr("stdDeviation", "3")
                    .attr("result", "coloredBlur");
                greenGlow.append("feFlood")
                    .attr("flood-color", "#22c55e")
                    .attr("flood-opacity", "0.5")
                    .attr("result", "greenColor");
                greenGlow.append("feComposite")
                    .attr("in", "greenColor")
                    .attr("in2", "coloredBlur")
                    .attr("operator", "in")
                    .attr("result", "greenGlow");

                const feMergeGreen = greenGlow.append("feMerge");
                feMergeGreen.append("feMergeNode").attr("in", "greenGlow");
                feMergeGreen.append("feMergeNode").attr("in", "SourceGraphic");

                // Create glow filter for red (negative change)
                const redGlow = defs.append("filter")
                    .attr("id", "redGlow")
                    .attr("x", "-50%")
                    .attr("y", "-50%")
                    .attr("width", "200%")
                    .attr("height", "200%");

                redGlow.append("feGaussianBlur")
                    .attr("stdDeviation", "3")
                    .attr("result", "coloredBlur");
                redGlow.append("feFlood")
                    .attr("flood-color", "#ef4444")
                    .attr("flood-opacity", "0.5")
                    .attr("result", "redColor");
                redGlow.append("feComposite")
                    .attr("in", "redColor")
                    .attr("in2", "coloredBlur")
                    .attr("operator", "in")
                    .attr("result", "redGlow");

                const feMergeRed = redGlow.append("feMerge");
                feMergeRed.append("feMergeNode").attr("in", "redGlow");
                feMergeRed.append("feMergeNode").attr("in", "SourceGraphic");

                // const sizeScale = d3.scaleSqrt()
                //     .domain([d3.min(data, d => d.marketCap), d3.max(data, d => d.marketCap)])
                //     .range([sizes.minSize, sizes.maxSize]);
                //         const sizeScale = d3.scaleSqrt()
                // .domain([d3.min(data, d => d.marketCap), d3.max(data, d => d.marketCap)])
                // .range(page === 1 ? 
                //     [70, 140] :  // First page larger sizes
                //     [40, 100]     // Other pages smaller sizes
                // );




                // data.forEach((d, i) => {
                //     const radius = Math.min(sizes.width, sizes.height) * 0.45;
                //     const theta = i * 2 * Math.PI / (1 + Math.sqrt(6));
                //     const r = radius * Math.sqrt(i / data.length);

                //     d.x = sizes.width / 2 + r * Math.cos(theta);
                //     d.y = sizes.height / 2 + r * Math.sin(theta);

                //     // const phi = (1 + Math.sqrt(5)) / 2;
                //     // const angle = i * 2 * Math.PI * phi;
                //     // const radius = Math.sqrt(i / data.length) * Math.min(sizes.width, sizes.height) * 0.45;

                //     // d.x = sizes.width / 2 + radius * Math.cos(angle);
                //     // d.y = sizes.height / 2 + radius * Math.sin(angle);
                //     //d.size = sizeScale(d.marketCap);

                //     change = d.change1h; // Using the current timeframe's change

                //    // const absChange = Math.abs(change);
                //    if(timeframe == '1h'){
                //     change = d.change1h;
                //    }
                //    if(timeframe == '24h'){
                //     change = d.change24h;
                //    }
                //    if(timeframe == '7d'){
                //     change = d.change7d;
                //    }
                //    if(timeframe == '30d'){
                //     change = d.change30d;
                //    }

                //     const absChange = Math.abs(change); //Math.abs(getChangePercent(d, timeframe));//

                //     d.size = calculateSquareSize(absChange, window.innerWidth , timeframe);


                //     // if(sizes.isSmallScreen)
                //     // {
                //     //     stroke =1;
                //     //     if (absChange > 200) {
                //     //         d.size = 160;  // Very high change (>20%)
                //     //     } else if (absChange > 150) {
                //     //         d.size = 150;  // Very high change (>20%)
                //     //     } else if (absChange > 100) {
                //     //         d.size = 120;  // Very high change (>20%)
                //     //     } else if (absChange > 50) {
                //     //         d.size = 100;  // Very high change (>20%)
                //     //     } else if (absChange > 30) {
                //     //         d.size = 100;  // Very high change (>20%)
                //     //     } else if (absChange > 20) {
                //     //         d.size = 90;  // Very high change (>20%)
                //     //     } else if (absChange > 10) {
                //     //         d.size = 80;  // Medium change (10-15%)
                //     //     } else if (absChange > 5) {
                //     //         d.size = 60;  // Low change (5-10%)
                //     //     } else if (absChange > 3) {
                //     //         d.size = 50;  // Very low change (<5%)
                //     //     } else if (absChange > 1) {
                //     //         d.size = 30;  // Very low change (<5%)
                //     //     } else if (absChange > 0) {
                //     //         d.size = 10;  // Very low change (<5%)
                //     //     }
                //     // }
                //     // else{
                //     //     stroke =3;

                //     //     if (absChange > 200) {
                //     //         d.size = 250;  // Very high change (>20%)
                //     //     }else if (absChange > 150) {
                //     //         d.size = 220;  // Very high change (>20%)
                //     //     }else if (absChange > 100) {
                //     //         d.size = 180;  // Very high change (>20%)
                //     //     }else if (absChange > 50) {
                //     //         d.size = 160;  // Very high change (>20%)
                //     //     }else if (absChange > 30) {
                //     //         d.size = 150;  // Very high change (>20%)
                //     //     }else if (absChange > 20) {
                //     //         d.size = 120;  // Very high change (>20%)
                //     //     } else if (absChange > 10) {
                //     //         d.size = 100;  // Medium change (10-15%)
                //     //     } else if (absChange > 5) {
                //     //         d.size = 80;  // Low change (5-10%)
                //     //     } else if (absChange > 3){
                //     //         d.size = 60;  // Very low change (<5%)
                //     //     } else if (absChange > 1){
                //     //         d.size = 30;  // Very low change (<5%)
                //     //     }else if (absChange > 0){
                //     //         d.size = 20;  // Very low change (<5%)
                //     //     }
                //     // }
                //     //     
                // });

                const width = window.innerWidth;
   const height = window.innerHeight;
                // Function to detect overlaps
   function hasOverlap(positions) {
       for(let i = 0; i < positions.length; i++) {
           for(let j = i + 1; j < positions.length; j++) {
               const dx = positions[i].x - positions[j].x;
               const dy = positions[i].y - positions[j].y;
               const distance = Math.sqrt(dx * dx + dy * dy);
               const minDistance = (positions[i].size + positions[j].size) / 1.5;
               if(distance < minDistance) return true;
           }
       }
       return false;
   }

   // Function to calculate sizes
   function calculateSizes(reductionFactor = 1,timeframe) {
       return data.map(d => {
        let change = Math.abs(d.change1h);
        let maxSize = Math.min( width, height) * 0.40 * reductionFactor;
        let size;

        if (timeframe == '1h') {
               change = Math.abs(d.change1h);
               if (width < 768) {
               if (change > 200) size = 120 * reductionFactor;
               else if (change > 100) size = 100 * reductionFactor;
               else if (change > 30) size = 80 * reductionFactor;
               else if (change > 20) size = 70 * reductionFactor;
               else if (change > 5) size = 65 * reductionFactor;
               else if (change > 3) size = 60 * reductionFactor;
               else if (change > 2) size = 55 * reductionFactor;
               else if (change > 1.5) size = 50 * reductionFactor;
               else if (change > 1) size = 45 * reductionFactor;
               else if (change > 0.5) size = 40 * reductionFactor;
               else size = 30 * reductionFactor;
           } else {
               if (change > 200) size = maxSize;
               else if (change > 100) size = maxSize * 0.8;
               else if (change > 30) size = maxSize * 0.7;
               else if (change > 20) size = maxSize * 0.65;
               else if (change > 10) size = maxSize * 0.6;
               else if (change > 5) size = maxSize * 0.5;
               else if (change > 3) size = maxSize * 0.45;
               else if (change > 2.5) size = maxSize * 0.4;
               else if (change > 2) size = maxSize * 0.35;
               else if (change > 1.5) size = maxSize * 0.3;
               else if (change > 1) size = maxSize * 0.25;
               else if (change > 0.5) size = maxSize * 0.2;
               else size = maxSize* 0.1;
           }
        }
        if (timeframe == '24h') {
               change = Math.abs(d.change24h);
               maxSize = Math.min( width, height) * 0.35 * reductionFactor;

               if (width < 768) {
                    if (change > 200) size = 100 * reductionFactor;
                    else if (change > 100) size = 80 * reductionFactor;
                    else if (change > 30) size = 60 * reductionFactor;
                    else if (change > 20) size = 50 * reductionFactor;
                    else if (change > 10) size = 50 * reductionFactor;
                    else if (change > 5) size = 45 * reductionFactor;
                    else if (change > 3) size = 40 * reductionFactor;
                    else if (change > 1) size = 30 * reductionFactor;
                    else size = 20 * reductionFactor;
                } else {
                    if (change > 500) size = maxSize;
                    else if (change > 400) size = maxSize * 0.8;
                    else if (change > 200) size = maxSize * 0.75;
                    else if (change > 100) size = maxSize * 0.7;
                    else if (change > 50) size = maxSize * 0.6;
                    else if (change > 30) size = maxSize * 0.5;
                    else if (change > 20) size = maxSize * 0.4;
                    else if (change > 10) size = maxSize * 0.35;
                    else if (change > 5) size = maxSize * 0.3;
                    else if (change > 3) size = maxSize * 0.25;
                    else if (change > 2) size = maxSize * 0.15;
                    else if (change > 1) size = maxSize * 0.10;
                    else size = maxSize* 0.08;
           }
           }
        if (timeframe == '7d') {
            change = Math.abs(d.change7d);
               maxSize = Math.min( width, height) * 0.20 * reductionFactor;

               if (width < 768) {
                if (change > 500) size = 100 * reductionFactor;
                    else if (change > 300) size = 90 * reductionFactor;
                    else if (change > 200) size = 85 * reductionFactor;
                    else if (change > 100) size = 80 * reductionFactor;
                    else if (change > 30) size = 60 * reductionFactor;
                    else if (change > 20) size = 50 * reductionFactor;
                    else if (change > 10) size = 45 * reductionFactor;
                    else if (change > 5) size = 40 * reductionFactor;
                    else size = 15 * reductionFactor;
                } else {
                    if (change > 500) size = maxSize;
                    else if (change > 400) size = maxSize * 0.8;
                    else if (change > 200) size = maxSize * 0.75;
                    else if (change > 100) size = maxSize * 0.75;
                    else if (change > 50) size = maxSize * 0.7;
                    else if (change > 30) size = maxSize * 0.6;
                    else if (change > 20) size = maxSize * 0.5;
                    else if (change > 10) size = maxSize * 0.4;
                    else if (change > 5) size = maxSize * 0.3;
                    //else if (change > 3) size = maxSize * 0.3;
                    //else if (change > 2) size = maxSize * 0.25;
                    //else if (change > 1) size = maxSize * 0.2;
                    else size = maxSize* 0.08;
           }
           }
        if (timeframe == '30d') {
            change = Math.abs(d.change30d);
               maxSize = Math.min( width, height) * 0.15 * reductionFactor;

               if (width < 768) {
                
                 if (change > 500) size = 100 * reductionFactor;
                    else if (change > 300) size = 90 * reductionFactor;
                    else if (change > 200) size = 70 * reductionFactor;
                    else if (change > 100) size = 60 * reductionFactor;
                    else if (change > 50) size = 50 * reductionFactor;
                    else if (change > 40) size = 40 * reductionFactor;
                    //else if (change > 10) size = 45 * reductionFactor;
                   // else if (change > 5) size = 40 * reductionFactor;
                    else size = 20 * reductionFactor;
                } else {
                    if (change > 1000) size = maxSize;
                    else if (change > 500) size = maxSize * 0.82;
                    else if (change > 400) size = maxSize * 0.8;
                    else if (change > 200) size = maxSize * 0.75;
                    else if (change > 100) size = maxSize * 0.75;
                    else if (change > 50) size = maxSize * 0.7;
                    else if (change > 30) size = maxSize * 0.6;
                    else if (change > 20) size = maxSize * 0.6;
                    else if (change > 10) size = maxSize * 0.5;
                    else if (change > 5) size = maxSize * 0.4;
                    //else if (change > 3) size = maxSize * 0.3;
                    //else if (change > 2) size = maxSize * 0.25;
                    //else if (change > 1) size = maxSize * 0.2;
                    else size = maxSize* 0.08;
           }
           }
        if (timeframe == '365d') {
            change = Math.abs(d.change365d);
               maxSize = Math.min( width, height) * 0.20 * reductionFactor;

               if (width < 768) {
                if (change > 1000) size = 100 * reductionFactor;
                else if (change > 500) size = 90 * reductionFactor;
                    else if (change > 300) size = 80 * reductionFactor;
                    else if (change > 200) size = 70 * reductionFactor;
                    else if (change > 100) size = 60 * reductionFactor;
                    else if (change > 50) size = 50 * reductionFactor;
                    else if (change > 40) size = 40 * reductionFactor;
                    //else if (change > 10) size = 30 * reductionFactor;
                    //else if (change > 5) size = 20 * reductionFactor;
                    else size = 20 * reductionFactor;
                } else {
                    if (change > 1000) size = maxSize;
                    else if (change > 500) size = maxSize*0.8;
                    else if (change > 400) size = maxSize * 0.7;
                    else if (change > 200) size = maxSize * 0.65;
                    else if (change > 100) size = maxSize * 0.6;
                    else if (change > 50) size = maxSize * 0.45
                    else if (change > 30) size = maxSize * 0.4;
                    else if (change > 20) size = maxSize * 0.35;
                    else if (change > 10) size = maxSize * 0.3;
                    else if (change > 5) size = maxSize * 0.2;
                    //else if (change > 3) size = maxSize * 0.3;
                    //else if (change > 2) size = maxSize * 0.25;
                    //else if (change > 1) size = maxSize * 0.2;
                    else size = maxSize* 0.08;
           }
           }
        if (timeframe == 'mcap') {
            const marketCapSize = Math.log10(d.marketCapChange24h);
               maxSize = Math.min( width, height) * 0.20 * reductionFactor;

               if(window.innerWidth < 768) {
                        if(marketCapSize > 11) d.size = 120;
                        else if(marketCapSize > 10) d.size = 100;
                        else if(marketCapSize > 9) d.size = 80;
                        else if(marketCapSize > 8) d.size = 60;
                        else d.size = 40;
                    } else {
                        if(marketCapSize > 11) d.size = 250;
                        else if(marketCapSize > 10) d.size = 200;
                        else if(marketCapSize > 9) d.size = 150;
                        else if(marketCapSize > 8) d.size = 100;
                        else d.size = 50;
                    }
           }

           return {
               ...d,
               size: size
           };
       });
   }

   // Initialize with positions and check for overlaps
   let reductionFactor = 1;
   let currentData = calculateSizes(reductionFactor,timeframe);
   let iterations = 0;
   const maxIterations = 10;

   while (hasOverlap(currentData) && iterations < maxIterations) {
       reductionFactor *= 0.9; // Reduce sizes by 10% each iteration
       currentData = calculateSizes(reductionFactor);
       iterations++;
   }

   data = currentData;

//    simulation = d3.forceSimulation(data)
//                     .alphaDecay(0.01)
//                     .alphaMin(0.001)
//                     .velocityDecay(0.5)
//        .force("charge", d3.forceManyBody().strength(d => -d.size * 2))
//        .force("collide", d3.forceCollide().radius(d => d.size * 0.7).strength(1))
//        .force("x", d3.forceX(width / 2).strength(0.05))
//        .force("y", d3.forceY(height / 2).strength(0.05));
                simulation = d3.forceSimulation(data)
                    .alphaDecay(0.01)
                    .alphaMin(0.001)
                    .velocityDecay(0.5)
                    .force("charge", d3.forceManyBody()
                        .strength(d => -Math.pow(d.size, 1.2))
                        .distanceMax(Math.min(sizes.width, sizes.height) * 0.8))
                    .force("collide", d3.forceCollide()
                        .radius(d => d.size * 0.7)
                        .strength(0.2)
                        .iterations(5))
                    //.force("x", d3.forceX(sizes.width / 2).strength(0.03))
                    //.force("y", d3.forceY(sizes.height / 2).strength(0.03));
                    .force("x", d3.forceX().x(d => {
                        // Spread across multiple columns
                        const columns = 8;
                        const section = Math.floor(Math.random() * columns);
                        return (sizes.width * (section + 0.5) / columns);
                    }).strength(0.05))
                    .force("y", d3.forceY().y(d => {
                        // Spread across multiple rows
                        const rows = 5;
                        const section = Math.floor(Math.random() * rows);
                        return (sizes.height * (section + 0.5) / rows);
                    }).strength(0.05));

                    const cryptoPopup = new CryptoPopup();
                squareGroups = svg.selectAll("g")
                    .data(data)
                    .enter()
                    .append("g")
                    .attr("class", "square-container");
                    

                squareGroups.each(function (d) {
                    const group = d3.select(this);

                    
                    if(timeframe == '1h'){
                    change = d.change1h;
                   }
                   if(timeframe == '24h'){
                    change = d.change24h;
                   }
                   if(timeframe == '7d'){
                    change = d.change7d;
                   }
                   if(timeframe == '30d'){
                    change = d.change30d;
                   }
                   if(timeframe == '365d'){
                    change = d.change365d;
                   }
                   if(timeframe == 'mcap'){
                    change = d.marketCapChange24h;
                   }

                    // Background square with transparent fill and glowing border
                    group.append("rect")
                        .attr("class", "square")
                        .attr("width", d.size)
                        .attr("height", d.size)
                        .attr("x", -d.size / 2)
                        .attr("y", -d.size / 2)
                        .style("fill", "rgba(0, 0, 0, 0.2)")
                        .style("stroke", change >= 0 ? "#22c55e" : "#ef4444")
                        .style("stroke-width", stroke)
                        // .attr("rx", 8)
                        // .attr("ry", 8)
                        .style("filter", change >= 0 ? "url(#greenGlow)" : "url(#redGlow)")
                        .style("transition", "all 0.2s ease")
                        .on("click", function(event) {
                            event.stopPropagation();
                            cryptoPopup.show(d);
                        })
                        // .on("click", showDetails)
                        .on("mouseover", function () {
                            d3.select(this)
                                .style("stroke", "white")
                                .style("stroke-width", "4")
                                .style("filter", "url(#whiteGlow)");
                        })
                        .on("mouseout", function (event, d) {
                            d3.select(this)
                                .style("stroke", change >= 0 ? "#22c55e" : "#ef4444")
                                .style("stroke-width", "3")
                                .style("filter", change >= 0 ? "url(#greenGlow)" : "url(#redGlow)");
                        });

                    // Logo circle
                    //const logoSize = d.size * sizes.logoScale;
                    // group.append("circle")
                    //     .attr("class", "currency-logo")
                    //     .attr("r", logoSize / 2)
                    //     .attr("cx", 0)
                    //     .attr("cy", -d.size * 0.15)
                    //     .attr("fill", d.logoColor);

                    let logoSize = Math.abs(change) > 1 ? d.size * 0.3 : d.size * 0.6; // Adjust size as needed

                    if (sizes.isSmallScreen) {
                        stroke = 2;
                        logoSize = Math.abs(change) > 5 ? d.size * 0.3 : d.size * 0.6;
                    }
                    else {
                        stroke = 3;
                    }

                    if(timeframe == '1h'){
                        logoSize = Math.abs(change) > 1 ? d.size * 0.3 : d.size * 0.4;
                    }

                    // Method 1: Using image element
                    group.append("image")
                        .attr("class", "crypto-logo")
                        .attr("x", -logoSize / 2)
                        .attr("y", -d.size * 0.25)
                        .attr("width", logoSize)
                        .attr("height", logoSize)
                        .attr("href", d.logoUrl);

                        const displayValue = d => {
            if (d.marketCap) return `$${(d.marketCap / 1e9).toFixed(1)}B`;
            if (d.volume) return `$${(d.volume / 1e9).toFixed(1)}B`;
            return '';
        };

                    if (sizes.isSmallScreen) {
                        if (Math.abs(change) > 0.5) {
                            // Symbol text
                            if(timeframe == '24h' || timeframe == '7d'  ){
                                if (Math.abs(change) > 5) {
                                group.append("text")
                                    .attr("class", "square-label")
                                    .attr("dy", d.size * 0.2)
                                    .text(d.symbol)
                                    .style("font-size", `${d.size * sizes.textScale}px`);

                                // Percentage change
                                group.append("text")
                                    .attr("class", "percentage-label")
                                    .attr("dy", d.size * 0.4)
                                    .text(change.toFixed(1) + "%")
                                    .style("font-size", `${d.size * (sizes.textScale - 0.02)}px`)
                                    .style("fill", change >= 0 ? "#22c55e" : "#ef4444");
                                }
                            }
                            else  if(timeframe == '30d'|| timeframe == '365d'){
                                if (Math.abs(change) > 40) {
                                group.append("text")
                                    .attr("class", "square-label")
                                    .attr("dy", d.size * 0.2)
                                    .text(d.symbol)
                                    .style("font-size", `${d.size * sizes.textScale}px`);

                                // Percentage change
                                group.append("text")
                                    .attr("class", "percentage-label")
                                    .attr("dy", d.size * 0.4)
                                    .text(change.toFixed(1) + "%")
                                    .style("font-size", `${d.size * (sizes.textScale - 0.02)}px`)
                                    .style("fill", change >= 0 ? "#22c55e" : "#ef4444");
                                }
                            }
                            else{
                            group.append("text")
                                .attr("class", "square-label")
                                .attr("dy", d.size * 0.2)
                                .text(d.symbol)
                                .style("font-size", `${d.size * sizes.textScale}px`);

                            // Percentage change
                            group.append("text")
                                .attr("class", "percentage-label")
                                .attr("dy", d.size * 0.4)
                                .text(change.toFixed(1) + "%")
                                .style("font-size", `${d.size * (sizes.textScale - 0.02)}px`)
                                .style("fill", change >= 0 ? "#22c55e" : "#ef4444");
                                }
                        }
                    }
                    else {
                        if (timeframe == '1h') {
                            if (Math.abs(change) > 0.5) {
                                group.append("text")
                                    .attr("class", "square-label")
                                    .attr("dy", d.size * 0.2)
                                    .text(d.symbol)
                                    .style("font-size", `${d.size * sizes.textScale}px`);

                                // Percentage change
                                group.append("text")
                                    .attr("class", "percentage-label")
                                    .attr("dy", d.size * 0.4)
                                    .text(change.toFixed(1) + "%")
                                    .style("font-size", `${d.size * (sizes.textScale - 0.02)}px`)
                                    .style("fill", change >= 0 ? "#22c55e" : "#ef4444");
                            }
                        }
                        else if (timeframe == '24h') {
                            if (Math.abs(change) > 2) {
                                group.append("text")
                                    .attr("class", "square-label")
                                    .attr("dy", d.size * 0.2)
                                    .text(d.symbol)
                                    .style("font-size", `${d.size * sizes.textScale}px`);

                                // Percentage change
                                group.append("text")
                                    .attr("class", "percentage-label")
                                    .attr("dy", d.size * 0.4)
                                    .text(change.toFixed(1) + "%")
                                    .style("font-size", `${d.size * (sizes.textScale - 0.02)}px`)
                                    .style("fill", change >= 0 ? "#22c55e" : "#ef4444");
                            }
                        }
                        else if (timeframe == '24h' ||timeframe == '7d' || timeframe == '30d') {
                            if (Math.abs(change) > 5) {
                                group.append("text")
                                    .attr("class", "square-label")
                                    .attr("dy", d.size * 0.2)
                                    .text(d.symbol)
                                    .style("font-size", `${d.size * sizes.textScale}px`);

                                // Percentage change
                                group.append("text")
                                    .attr("class", "percentage-label")
                                    .attr("dy", d.size * 0.4)
                                    .text(change.toFixed(1) + "%")
                                    .style("font-size", `${d.size * (sizes.textScale - 0.02)}px`)
                                    .style("fill", change >= 0 ? "#22c55e" : "#ef4444");
                            }
                        }
                        else if (timeframe == '365d') {
                            if (Math.abs(change) > 0.5) {
                                group.append("text")
                                    .attr("class", "square-label")
                                    .attr("dy", d.size * 0.2)
                                    .text(d.symbol)
                                    .style("font-size", `${d.size * sizes.textScale}px`);

                                // Percentage change
                                group.append("text")
                                    .attr("class", "percentage-label")
                                    .attr("dy", d.size * 0.4)
                                    .text(change.toFixed(1) + "%")
                                    .style("font-size", `${d.size * (sizes.textScale - 0.02)}px`)
                                    .style("fill", change >= 0 ? "#22c55e" : "#ef4444");
                            }
                        }
                        else if (timeframe == 'mcap') {
                            group.append("text")
                                .attr("class", "square-label")
                                .attr("dy", d.size * 0.2)
                                .attr("text-anchor", "middle")
                                .text(d.symbol)
                                .style("font-size", `${d.size * 0.18}px`);

                            group.append("text")
                                .attr("class", "percentage-label")
                                .attr("dy", d.size * 0.4)
                                .attr("text-anchor", "middle")
                                .text(displayValue(d))
                                .style("font-size", `${d.size * 0.16}px`)
                                .style("fill", "#ffffff");
                        }
                        else {// (Math.abs(change) > 1) {
                            // Symbol text
                            group.append("text")
                                .attr("class", "square-label")
                                .attr("dy", d.size * 0.2)
                                .text(d.symbol)
                                .style("font-size", `${d.size * sizes.textScale}px`);

                            // Percentage change
                            group.append("text")
                                .attr("class", "percentage-label")
                                .attr("dy", d.size * 0.4)
                                .text(change + "%")
                                .style("font-size", `${d.size * (sizes.textScale - 0.02)}px`)
                                .style("fill", change >= 0 ? "#22c55e" : "#ef4444");
                        }
                    }
                });

                const drag = d3.drag()
                    .on("start", (event, d) => {
                        if (!event.active) simulation.alphaTarget(0.3).restart();
                        d.fx = d.x;
                        d.fy = d.y;
                        d3.select(event.sourceEvent.currentTarget).raise();
                    })
                    .on("drag", (event, d) => {
                        d.fx = event.x;
                        d.fy = event.y;
                    })
                    .on("end", (event, d) => {
                        if (!event.active) simulation.alphaTarget(0);
                        d.fx = null;
                        d.fy = null;
                    });

                squareGroups.call(drag);

                simulation.on("tick", () => {
                    squareGroups.attr("transform", d => {
                        const padding = d.size / 2 + sizes.padding;
                        d.x = Math.max(padding * 2, Math.min(sizes.width - padding, d.x));
                        d.y = Math.max(padding * 2, Math.min(sizes.height - padding, d.y));
                        return `translate(${d.x},${d.y})`;
                    });
                });

                 // Show details panel
        // function showDetails(event, d) {
        //     const details = d3.select("#details");
        //     const title = d3.select("#details-title");
        //     const content = d3.select("#details-content");

        //     title.html(`${d.name} (${d.symbol})`);
        //     content.html(`
        //         <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
        //             <div>
        //                 <div style="color: #999;">Price</div>
        //                 <div style="font-weight: bold;">$${d.price.toLocaleString()}</div>
        //             </div>
        //             <div>
        //                 <div style="color: #999;">24h Change</div>
        //                 <div style="font-weight: bold; color: ${d.change24h >= 0 ? '#22c55e' : '#ef4444'}">
        //                     ${d.change24h}%
        //                 </div>
        //             </div>
        //             <div>
        //                 <div style="color: #999;">Market Cap</div>
        //                 <div style="font-weight: bold;">${formatNumber(d.marketCap)}</div>
        //             </div>
        //         </div>
        //     `);

        //     details.classed("visible", true);
        // }
        //     //     squareGroups.on("click", function (event, d) {
            //         const details = d3.select("#details");
            //         const title = d3.select("#details-title");
            //         const content = d3.select("#details-content");

            //     //     if(timeframe == '1h'){
            //     //     change = d.change1h;
            //     //    }
            //     //    if(timeframe == '24h'){
            //     //     change = d.change24h;
            //     //    }
            //     //    if(timeframe == '7d'){
            //     //     change = d.change7d;
            //     //    }
            //     //    if(timeframe == '30d'){
            //     //     change = d.change30d;
            //     //    }
            //     //    if(timeframe == '365d'){
            //     //     change = d.change365d;
            //     //    }
            //     //    if(timeframe == 'mcap'){
            //     //     change = d.marketCap;
            //     //    }

            //         title.html(`${d.name} (${d.symbol})`);
            //         content.html(`
            //     <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
            //         <div>
            //             <div style="color: #999;">Price</div>
            //             <div style="font-weight: bold;">$${d.price.toLocaleString()}</div>
            //         </div>
            //         <div>
            //             <div style="color: #999;">24h Change</div>
            //             <div style="font-weight: bold; color: ${change >= 0 ? '#22c55e' : '#ef4444'}">
            //                 ${change}%
            //             </div>
            //         </div>
            //         <div>
            //             <div style="color: #999;">Market Cap</div>
            //             <div style="font-weight: bold;">${formatNumber(d.marketCap)}</div>
            //         </div>
            //     </div>
            // `);

            //         details.classed("visible", true);
            //     });

                // Hide details panel when clicking outside bubbles
                svg.on("click", function (event) {
                    if (event.target.tagName === "svg") {
                        d3.select("#details").classed("visible", false);
                    }
                });
            }

        // Format numbers for display
        // function formatNumber(num) {
        //     if (num >= 1e9) return `$${(num / 1e9).toFixed(1)}B`;
        //     if (num >= 1e6) return `$${(num / 1e6).toFixed(1)}M`;
        //     return `$${num.toFixed(2)}`;
        // }
        

        let resizeTimeout;
        window.addEventListener("resize", () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                //sizes = getResponsiveSizes();
                //initializeWithRealData(1,'24h');
                initializeVisualization(1,'24h');
            }, 100);
        });

        //initializeVisualization();
        // function createSquares() {
        //     squareGroups.each(function(d) {
        //         const group = d3.select(this);
                
        //         // Background square
        //         group.append("rect")
        //             .attr("class", "square")
        //             .attr("width", d.size)
        //             .attr("height", d.size)
        //             .attr("x", -d.size / 2)
        //             .attr("y", -d.size / 2)
        //             .style("fill", "rgba(0, 0, 0, 0.2)")
        //             .style("stroke", d => d.change24h >= 0 ? "#22c55e" : "#ef4444")
        //             .style("stroke-width", "2")
        //             .attr("rx", 8)
        //             .attr("ry", 8)
        //             .style("filter", d => d.change24h >= 0 ? "url(#greenGlow)" : "url(#redGlow)");

        //         // Logo image
        //         group.append("image")
        //             .attr("class", "crypto-logo")
        //             .attr("x", -12)
        //             .attr("y", -d.size * 0.25)
        //             .attr("width", 24)
        //             .attr("height", 24)
        //             .attr("href", d.logoUrl);

        //         // Symbol text
        //         group.append("text")
        //             .attr("class", "square-label")
        //             .attr("dy", d.size * 0.2)
        //             .text(d.symbol)
        //             .style("font-size", `${d.size * sizes.textScale}px`);

        //         // Percentage change
        //         group.append("text")
        //             .attr("class", "percentage-label")
        //             .attr("dy", d.size * 0.4)
        //             .text(d.change24h.toFixed(1) + "%")
        //             .style("font-size", `${d.size * (sizes.textScale - 0.02)}px`)
        //             .style("fill", d => d.change24h >= 0 ? "#22c55e" : "#ef4444");
        //     });
        // }

        // // Add refresh button handler
        //d3.select(".refresh-btn").on("click", initializeWithRealData);

        // Add pagination controls
        function addPaginationControls() {
            const controls = document.createElement('div');
            controls.className = 'pagination-controls';
            controls.innerHTML = `
                <button class="prev-page" onclick="changePage(-1)">Previous</button>
                <span class="page-number">Page 1</span>
                <button class="next-page" onclick="changePage(1)">Next</button>
            `;
            document.body.appendChild(controls);
        }

        // Handle page changes
        let currentPage = 1;

        async function changePage(delta) {
            let newPage = delta;
            if (newPage < 1) return;
            
            currentPage = newPage;
            await initializeWithRealData(currentPage, session_timeframe);
            
            // Update page number display
            //document.querySelector('.page-number').textContent = `Page ${currentPage}`;
            //document.querySelector('.prev-page').disabled = currentPage === 1;
        }

        function showLoader() {
            // Add loader styles
            const style = document.createElement('style');
            style.textContent = loaderStyles;
            document.head.appendChild(style);

            // Add loader HTML
            const loaderDiv = document.createElement('div');
            loaderDiv.innerHTML = loaderHTML;
            document.body.appendChild(loaderDiv);

            return {
        updateProgress: (percent) => {
            const progressBar = document.querySelector('.progress-bar');
            const percentageText = document.querySelector('.loader-percentage');
            if (progressBar && percentageText) {
                progressBar.style.width = `${percent}%`;
                percentageText.textContent = `${Math.round(percent)}%`;
            }
        },
        setLoadingText: (text) => {
            const loadingText = document.querySelector('.loader-text');
            if (loadingText) {
                loadingText.textContent = text;
            }
        },
        hide: () => {
            const loader = document.querySelector('.crypto-loader');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.remove(), 300);
            }
        }
    };
        }
        // Initialize
        // document.addEventListener('DOMContentLoaded', () => {
        //     addPaginationControls();
        //     initializeWithRealData(1);
        // });
        // Add event handlers
document.addEventListener('DOMContentLoaded', () => {
    let currentTimeframe = '1h';
    let currentSort = 'percent';

    // Handle timeframe changes
    document.querySelectorAll('.timeframe-controls li a').forEach(button => {
        button.addEventListener('click', async () => {
            // Update active state
            document.querySelectorAll('.timeframe-controls li a').forEach(b => 
                b.classList.remove('active'));
            button.classList.add('active');

            // Update data and visualization
            session_timeframe = button.dataset.time;
            const livedata = await fetchCryptoData(1,100,session_timeframe, currentSort);
            data = livedata;
            initializeVisualization('1', session_timeframe);
        });
    });

    // Handle sort changes
    document.querySelectorAll('.sort-controls li a').forEach(button => {
        button.addEventListener('click', async () => {
            // Update active state
            document.querySelectorAll('.sort-controls li a').forEach(b => 
                b.classList.remove('active'));
            button.classList.add('active');

            // Update data and visualization
            currentSort = button.dataset.sort;
            const livedata = await fetchCryptoData(1,100,currentTimeframe, currentSort);
            data = livedata;
            initializeVisualization('1', currentTimeframe);
        });
    });

    // Initial load
    initializeWithRealData();
});

// Search functionality
function initializeSearch() {
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    let searchTimeout;

    searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const searchTerm = e.target.value.toLowerCase();

        searchTimeout = setTimeout(() => {
            if (searchTerm.length < 1) {
                searchResults.style.display = 'none';
                return;
            }

            const matches = data.filter(coin => 
                coin.name.toLowerCase().includes(searchTerm) || 
                coin.symbol.toLowerCase().includes(searchTerm)
            ).slice(0, 10);

            if (matches.length > 0) {
                searchResults.innerHTML = matches.map(coin => `
                    <div class="search-result-item" data-id="${coin.id}">
                        <img src="${coin.logoUrl}" alt="${coin.name}">
                        <div>
                            <div>${coin.name}</div>
                            <div style="color: rgba(255,255,255,0.6)">${coin.symbol}</div>
                        </div>
                    </div>
                `).join('');

                const cryptoPopup = new CryptoPopup();
                const resultItems = searchResults.querySelectorAll('.search-result-item');
                resultItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const coinId = item.dataset.id;
                        const coinData = data.find(c => c.id === parseInt(coinId));
                        if (coinData) {
                            cryptoPopup.show(coinData);
                            searchResults.style.display = 'none';
                            searchInput.value = '';
                        }
                    });
                });


                searchResults.style.display = 'block';
            } else {
                searchResults.style.display = 'none';
            }
        }, 300);
    });

    // Handle search result clicks
    searchResults.addEventListener('click', (e) => {
        const resultItem = e.target.closest('.search-result-item');
        if (resultItem) {
            const coinId = resultItem.dataset.id;
            const coin = data.find(c => c.id === coinId);
            if (coin) {
                // Highlight the selected coin
                highlightCoin(coin);
            }
            searchResults.style.display = 'none';
            searchInput.value = '';
        }
    });

    // Close search results when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-container')) {
            searchResults.style.display = 'none';
        }
    });
}
class LoadingManager {
    constructor() {
        this.loadingScreen = document.querySelector('.loading-screen');
        this.loadingBar = document.querySelector('.loading-bar');
        this.loadingText = document.querySelector('.loading-text');
        this.loadingPercentage = document.querySelector('.loading-percentage');
        this.progress = 0;
    }

    setProgress(progress, text = null) {
        this.progress = Math.min(100, Math.max(0, progress));
        this.loadingBar.style.width = `${this.progress}%`;
        this.loadingPercentage.textContent = `${Math.round(this.progress)}%`;
        if (text) {
            this.loadingText.textContent = text;
        }
    }

    show() {
        this.loadingScreen.style.display = 'flex';
    }

    hide() {
        this.loadingScreen.style.opacity = '0';
        this.loadingScreen.style.transition = 'opacity 0.5s ease';
        setTimeout(() => {
            this.loadingScreen.style.display = 'none';
            this.loadingScreen.style.opacity = '1';
        }, 500);
    }
}
// Helper function for delays
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Auto refresh function
function startAutoRefresh() {
    // Clear any existing interval
    if (window.refreshInterval) {
        clearInterval(window.refreshInterval);
    }

    // Set new interval
    window.refreshInterval = setInterval(async () => {
        const loading = new LoadingManager();
        loading.show();
        
        try {
            loading.setProgress(20, 'Refreshing data...');
            const newData = await fetchCryptoData(1,100,session_timeframe == null ? '24h' : session_timeframe);
            
            loading.setProgress(60, 'Updating visualization...');
            if (newData.length > 0) {
                data = newData;
                await initializeVisualization(data);
            }
            
            loading.setProgress(100, 'Complete!');
            await delay(300);
            loading.hide();
            
        } catch (error) {
            console.error('Auto-refresh failed:', error);
            loading.setProgress(100, 'Refresh failed');
            await delay(1000);
            loading.hide();
        }
    }, 5 * 60 * 1000); // 5 minutes interval
}

// Add cleanup on page unload
// window.addEventListener('beforeunload', () => {
//     if (window.refreshInterval) {
//         clearInterval(window.refreshInterval);
//     }
// });

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    initializeWithRealData(1,100,'24h');
});


class DataUpdaterLine {
    constructor() {
        this.progressLine = document.querySelector('.progress-line');
        this.timeLeft = 180; // 60 seconds timer
        this.interval = null;
    }

    start() {
this.timeLeft = 180;
this.progressLine.style.transform = 'translateX(-100%)';
this.progressLine.offsetHeight;

this.progressLine.style.transition = 'transform 180s linear';
        this.progressLine.style.transform = 'translateX(0)';


        this.timeout = setTimeout(() => {
            this.refreshData();
        }, 180000);

    }

    

    stop() {
        if (this.interval) {
            clearInterval(this.interval);
        }
    }

    async refreshData() {
        try {
            // Reset progress bar to 0
            this.progressLine.style.transition = 'none';
            this.progressLine.style.transform = 'scaleX(0)';
            
            const newData = await fetchCryptoData(1,100,session_timeframe == null ? '24h' : session_timeframe );
            // Fetch new data
            // const newData = await fetchCryptoData();
            if (newData.length > 0) {
                data = newData;
                initializeWithRealData(session_timeframe);
            }

            // Restore transition and start new progress
            setTimeout(() => {
                this.start();
            }, 1000);


        } catch (error) {
            console.error('Refresh failed:', error);
        }
    }
}

// Initialize
function startDataUpdater() {
    const updater = new DataUpdaterLine();
    updater.start();
    window.dataUpdater = updater;
}

// Start after initial load
document.addEventListener('DOMContentLoaded', () => {
    initializeWithRealData().then(() => {
        startDataUpdater();
    });
});

// Cleanup
window.addEventListener('beforeunload', () => {
    if (window.dataUpdater) {
        window.dataUpdater.stop();
    }
});

// Pause animation when tab is inactive
document.addEventListener('visibilitychange', () => {
    const progressLine = document.querySelector('.progress-line');
    if (document.hidden) {
        progressLine.style.animationPlayState = 'paused';
    } else {
        progressLine.style.animationPlayState = 'running';
    }
});

class CryptoPopup {
    constructor() {
        this.popup = document.getElementById('cryptoPopup');
        this.overlay = document.getElementById('overlay');
        this.isOpen = false;
        this.setupCloseButton();
    }

    setupCloseButton() {
        const closeButton = this.popup.querySelector('.close-button');
        closeButton.addEventListener('click', () => this.hide());

        // Close on overlay click
        this.overlay.addEventListener('click', () => this.hide());
    }

    show(coinData) {
    // if (this.isOpen) return;
    //     this.isOpen = true;
        // Show overlay first
        this.overlay.style.display = 'block';

        // Format numbers
        const formatNumber = (num) => {
            if (num >= 1e9) return `$${(num / 1e9).toFixed(2)}B`;
            if (num >= 1e6) return `$${(num / 1e6).toFixed(2)}M`;
            if (num >= 1e3) return `$${(num / 1e3).toFixed(2)}K`;
            return `$${num.toFixed(2)}`;
        };

        // Update popup content
        this.popup.querySelector('.coin-logo').src = coinData.logoUrl;
        this.popup.querySelector('.coin-name').textContent = coinData.name;
        this.popup.querySelector('.coin-symbol').textContent = coinData.symbol;
        
        this.popup.querySelector('.price').textContent = 
            formatNumber(coinData.price);
        
        const change24h = this.popup.querySelector('.change24h');
        change24h.textContent = `${coinData.change24h.toFixed(2)}%`;
        change24h.className = `detail-value change24h ${coinData.change24h >= 0 ? 'positive' : 'negative'}`;
        
        this.popup.querySelector('.market-cap').textContent = 
            formatNumber(coinData.marketCap);
        this.popup.querySelector('.volume').textContent = 
            formatNumber(coinData.volume);

        // Show popup with animation
        this.popup.style.display = 'block';
        requestAnimationFrame(() => {
            this.popup.style.opacity = '1';
            this.popup.style.transform = 'translate(-50%, -50%)';
        });
    }

    hide() {
        this.popup.style.opacity = '0';
        this.popup.style.transform = 'translate(-50%, -60%)';
        this.overlay.style.display = 'none';
        
        setTimeout(() => {
            this.popup.style.display = 'none';
        }, 300);
    }
}
    </script>
    <!-- <script>
        // Select the SVG and set up viewBox for responsiveness
        const modal = document.getElementById("modal2");
        const modalClose = document.querySelector(".modal-close");
        modalClose.onclick = function() {
        modal.style.display = "none";
        };

        window.onclick = function(event) {
        if (event.target === modal) {
            modal.style.display = "none";
        }
        };
        // Initial width, height, and squareSize based on screen size
let width = window.innerWidth;
let height = window.innerHeight* 0.8;
const borderColors = ["#FF3131", "#228B22","#50C878","#FA5F55"];

const shadowOpacity = 0.5;  // Opacity for shadow
const svg = d3.select("svg")
              .attr("viewBox", `0 0 ${width} ${height}`)
              .attr("preserveAspectRatio", "xMidYMid meet")
              .style("width", "100%") // Responsive width
              .style("height", "100%"); // Responsive height


let squareSize = Math.min(70, width / 10); // Adjust square size based on screen width
const padding = 10;
const logoSize = squareSize / 4; // Adjust logo size relative to square size

svg.append("defs");
// Function to create squares based on current dimensions
function createSquares() {
    width = window.innerWidth;
    height = window.innerHeight* 0.8;
    squareSize = Math.min(70, width / 10); // Recalculate square size
    const cols = Math.floor(width / squareSize);

    svg.selectAll("*").remove(); // Clear SVG content on resize

    // Load and process data
    d3.csv("currencies.csv").then(data => {
        const squares = [];
        data.forEach(d => {
            let attempts = 0;
            let x, y, overlaps;
            const value = +d.Rates;
            
            do {
                x = Math.random() * (width - squareSize);
                y = Math.random() * (height - squareSize);
                overlaps = squares.some(square =>
                    x < square.x + squareSize &&
                    x + squareSize > square.x &&
                    y < square.y + squareSize &&
                    y + squareSize > square.y
                );
                attempts++;
            } while (overlaps && attempts < 100);

            if (attempts < 100) {
                squares.push({ x, y, name: d.Currency, value, image: d.image });
            }
        });

        // borderColors.forEach((color, i) => {
        //     createShadowFilter(color, `shadow-filter-${i}`);
        // });

        const groups = svg.selectAll(".square-group")
            .data(squares)
            .enter()
            .append("g")
            .attr("class", (d, i) => i % 2 === 0 ? "square-group float-horizontal" : "square-group float-vertical") // Alternate movement direction
    //        .attr("class", (d, i) => i % 2 === 0 ? "square-group float-left" : "square-group float-right") // Alternate classes
            .attr("transform", d => `translate(${d.x}, ${d.y})`); // Position group at square location


        // Create squares
        groups.append("rect")
            .attr("class", "square")
            .attr("x", d => d.x)
            .attr("y", d => d.y)
            .attr("width", squareSize)
            .attr("height", squareSize)
            //.attr("fill", (d, i) => d3.schemeCategory10[i % 10])
            .attr("fill", "#222")
            .attr("stroke", (d, i) => borderColors[i % borderColors.length])
            .attr("stroke-width", 2 )
            .on("mouseover", function(event, d) {
                d3.select(this)
                    .attr("stroke", "#fcfcff") // Change border color to gold on hover
                    .attr("stroke-width", 4 );
            })
            .on("mouseout", function(event, d, i) {
                d3.select(this)
                    .attr("stroke", (d, i) => borderColors[i % borderColors.length]); // Restore original border color
            })
            .attr("filter", "url(#drop-shadow)") // Apply inner shadow filter
            .each(function(d, i) {
                // Set shadow color to match border color
                d3.select(this)
                    .style("filter", `drop-shadow(2px 6px 6px ${borderColors[i % borderColors.length]})`);
            })
            .on("click", (event, d) => {
            modal.style.display = "block";
            modal.style.background = "rgba(0,0,0,0.5)"
            modalText.textContent = `Currency: ${d.name}\nRate: ${d.value}`;
        });

        // svg.selectAll(".square")
        //     .data(squares)
        //     .enter()
        //     .append("rect")
        //     .attr("class", "square")
        //     .attr("class", (d, i) => i % 2 === 0 ? "square float-left" : "square float-right")
        //     .attr("x", d => d.x)
        //     .attr("y", d => d.y)
        //     .attr("width", squareSize)
        //     .attr("height", squareSize)
        //     .attr("fill", (d, i) => d3.schemeCategory10[i % 10])
        //     .attr("stroke", (d, i) => borderColors[i % borderColors.length])
        //     .attr("stroke-width", 2)
        //     .style("animation-delay", () => `${Math.random() * 2}s`);

        // Add text inside squares
        groups.append("text")
            .attr("class", "square-text-name")
            .attr("x", d => d.x + squareSize / 2)
            .attr("y", d => d.y + squareSize / 2)
            .style("font-size", `${squareSize / 5}px`)
            .style("text-anchor", "middle")
            .text(d => d.name);
        // svg.selectAll(".square-text-name")
        //     .data(squares)
        //     .enter()
        //     .append("text")
        //     .attr("class", "square-text-name")
        //     //.attr("class", (d, i) => i % 2 === 0 ? "square float-left" : "square float-right")
        //     .attr("x", d => d.x + squareSize / 2)
        //     .attr("y", d => d.y + squareSize / 2)
        //     .style("font-size", `${squareSize / 5}px`)
        //     .style("text-anchor", "middle")
        //     .text(d => d.name)
        //     .style("animation-delay", () => `${Math.random() * 2}s`);

        groups.append("text")
            .attr("class", "square-value")
            .attr("x", d => d.x + squareSize / 2)
            .attr("y", d => d.y + (3 * squareSize) / 4)
            .style("font-size", `${squareSize / 5}px`)
            .style("text-anchor", "middle")
            .text(d => d.value);
        // svg.selectAll(".square-value")
        //     .data(squares)
        //     .enter()
        //     .append("text")
        //     .attr("class", "square-value")
        //     //.attr("class", (d, i) => i % 2 === 0 ? "square float-left" : "square float-right")
        //     .attr("x", d => d.x + squareSize / 2)
        //     .attr("y", d => d.y + (3 * squareSize) / 4)
        //     .style("font-size", `${squareSize / 5}px`)
        //     .style("text-anchor", "middle")
        //     .text(d => d.value)
        //     .style("animation-delay", () => `${Math.random() * 2}s`);

        groups.append("image")
            .attr("class", "square-image")
            .attr("xlink:href", d => d.image)
            .attr("x", d => d.x + (squareSize - logoSize) / 2)
            .attr("y", d => d.y + (squareSize - logoSize) / 8)
            .attr("width", logoSize)
            .attr("height", logoSize);
        // svg.selectAll(".square-image")
        //     .data(squares)
        //     .enter()
        //     .append("image")
        //     .attr("class", "square-image")
        //     //.attr("class", (d, i) => i % 2 === 0 ? "square float-left" : "square float-right")
        //     .attr("xlink:href", d => d.image)
        //     .attr("x", d => d.x + (squareSize - logoSize) / 2)
        //     .attr("y", d => d.y + (squareSize - logoSize) / 8)
        //     .attr("width", logoSize)
        //     .attr("height", logoSize)
        //     .style("animation-delay", () => `${Math.random() * 2}s`);
    });
}
function createShadowFilter(color, id) {
    const defs = svg.select("defs");

    // Add the filter element to the defs
    const filter = defs.append("filter")
        .attr("id", id)
        .attr("x", "-20%")
        .attr("y", "-20%")
        .attr("width", "140%")
        .attr("height", "140%");

    // Create a drop shadow with the specified color
    filter.append("feDropShadow")
        .attr("dx", 5)
        .attr("dy", 5)
        .attr("stdDeviation", 5)
        .attr("flood-color", color) // Set shadow color
        .attr("flood-opacity", 2.5); // Adjust shadow opacity as needed
}

// Initial creation of squares
createSquares();

// Redraw squares on window resize
window.addEventListener("resize", createSquares);

    </script> -->
   
    <!-- <script src="assets/js/script.js"></script> -->
    
</body>
</html>
